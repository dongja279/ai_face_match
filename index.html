<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AI ê´€ìƒê¶í•© â€” ë‘ ì‚¬ì§„ìœ¼ë¡œ ë³´ëŠ” ìš°ë¦¬ ì‚¬ì´</title>
  <style>
    :root{
      --bg:#f2f4f8; --ink:#101828; --muted:#667085;
      --panel:#ffffff; --line:#e5e7eb;
      --accent:#6ea8ff; --accent2:#7c6dff; --ok:#10b981; --dark:#0b1220;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--ink);
      font-family:-apple-system,BlinkMacSystemFont,"Apple SD Gothic Neo","Noto Sans KR",Segoe UI,Roboto,Helvetica,Arial}
    .wrap{max-width:820px;margin:18px auto;padding:0 14px}
    header{background:var(--panel);border:1px solid var(--line);border-radius:18px;padding:22px 18px;margin-bottom:14px}
    h1{margin:0 0 6px;font-size:28px;letter-spacing:.2px}
    .sub{margin:0;color:var(--muted);font-size:14px}

    .card{background:var(--panel);border:1px solid var(--line);border-radius:18px;padding:16px;margin-bottom:14px}
    .card h2{margin:0 0 12px;font-size:15px;color:#475467}

    /* ì—…ë¡œë“œ ì¹´ë“œ */
    .thumbs{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:640px){ .thumbs{grid-template-columns:1fr 1fr} }
    .thumb{
      position:relative;border-radius:16px;overflow:hidden;border:1px dashed #cbd5e1;
      background:var(--dark);height:56vw;max-height:420px;display:flex;align-items:center;justify-content:center;
    }
    @media(min-width:640px){ .thumb{height:48vw;max-height:420px} }
    .thumb img{width:100%;height:100%;object-fit:cover;display:none}
    .thumb.has-image{border:1px solid #1f2937}
    .thumb.has-image img{display:block}

    /* ì—…ë¡œë“œ ë²„íŠ¼(ë°˜ì‘í˜• ë¼ë²¨) */
    .pick{
      position:absolute;left:50%;bottom:10%;transform:translateX(-50%);
      width:min(86%,300px);border:none;border-radius:14px;cursor:pointer;
      font-weight:900;letter-spacing:.2px;font-size:clamp(14px,3.4vw,18px);
      line-height:1.2;padding:clamp(12px,3.4vw,16px) 12px;color:#fff;
      background:linear-gradient(135deg,var(--accent),var(--accent2));box-shadow:0 10px 24px rgba(0,0,0,.25);
      white-space:nowrap;
    }
    .thumb.has-image .pick{display:none}
    .replace{
      position:absolute;top:10px;right:10px;padding:8px 10px;border-radius:999px;border:1px solid #e2e8f0;
      background:#ffffffd9;color:#111827;font-size:12px;font-weight:700;cursor:pointer;display:none
    }
    .thumb.has-image .replace{display:inline-block}

    .meter{height:8px;background:#e5e7eb;border-radius:999px;overflow:hidden;margin:14px 0}
    .meter>div{height:100%;width:0%;background:linear-gradient(90deg,#22d3ee,#a78bfa,#22c55e)}

    .actions{display:grid;grid-template-columns:1fr;gap:10px}
    @media(min-width:520px){ .actions{grid-template-columns:1.2fr .8fr} }
    .btn{cursor:pointer;border:none;border-radius:14px;padding:16px 14px;font-weight:900;letter-spacing:.2px;font-size:16px}
    .btn-primary{background:linear-gradient(135deg,var(--accent),var(--accent2));color:#fff}
    .btn-outline{background:#0ea5a5;color:#fff}
    .btn-dark{background:#0b1626;color:#e6eeff}
    .btn-cta{background:#111827;color:#fff}

    .btn:disabled{opacity:.6;cursor:not-allowed}
    .muted{color:var(--muted);font-size:12px}

    /* ê²°ê³¼ */
    .result{display:grid;gap:12px}
    .section{border:1px solid #2a364a;border-radius:14px;background:#0b1220;color:#eef4ff;padding:14px}
    .pair{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:640px){ .pair{grid-template-columns:1fr 1fr} }
    .who{border:1px solid #2a364a;border-radius:12px;background:#0b1220;color:#eef4ff;padding:12px}
    .who h4{margin:0 0 6px;font-size:13px;color:#ffffff}
    .list{margin:8px 0 0 0;padding:0 0 0 16px}
    .list li{margin:4px 0;color:#e6eeff}
    .list li b{color:#ffffff}

    .scoreRow{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:640px){ .scoreRow{grid-template-columns:1fr 1fr} }
    .scoreCard{border:1px solid #2a364a;border-radius:12px;background:#0b1220;color:#eef4ff;padding:12px}
    .scoreTitle{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
    .badge{min-width:56px;height:56px;border-radius:50%;display:flex;align-items:center;justify-content:center;
      background:linear-gradient(135deg,#6ea8ff,#7c6dff);color:#fff;font-weight:900;font-size:18px;box-shadow:0 8px 22px rgba(0,0,0,.35)}
    .pill{padding:6px 10px;border-radius:999px;background:#0b1220;border:1px solid #2a364a;color:#dbe7ff;font-size:12px}
    .sharePanel{display:grid;gap:8px;margin-top:10px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>AI ê´€ìƒê¶í•©</h1>
      <p class="sub">ë‘ ì‚¬ëŒì˜ ì–¼êµ´ ì‚¬ì§„ì„ ì—…ë¡œë“œí•˜ë©´, ì‹¬ì¸µ ê¶í•© ë¶„ì„ì„ ì œê³µí•©ë‹ˆë‹¤. (ì¬ë¯¸ë¡œë§Œ ë³´ì„¸ìš”!)</p>
    </header>

    <!-- ì—…ë¡œë“œ -->
    <section class="card" id="uploadCard">
      <h2>ì‚¬ì§„ ì—…ë¡œë“œ</h2>

      <div class="thumbs">
        <!-- A -->
        <div class="thumb" id="thumbA" aria-label="A ë¯¸ë¦¬ë³´ê¸°">
          <img id="imgPreviewA" alt="A ë¯¸ë¦¬ë³´ê¸°">
          <input id="fileA" type="file" accept="image/*" hidden>
          <button id="pickA" class="pick" type="button">ğŸ‘¤ A ì‚¬ì§„ ì—…ë¡œë“œ</button>
          <button id="replaceA" class="replace" type="button">ë³€ê²½</button>
        </div>
        <!-- B -->
        <div class="thumb" id="thumbB" aria-label="B ë¯¸ë¦¬ë³´ê¸°">
          <img id="imgPreviewB" alt="B ë¯¸ë¦¬ë³´ê¸°">
          <input id="fileB" type="file" accept="image/*" hidden>
          <button id="pickB" class="pick" type="button">ğŸ‘¤ B ì‚¬ì§„ ì—…ë¡œë“œ</button>
          <button id="replaceB" class="replace" type="button">ë³€ê²½</button>
        </div>
      </div>

      <div class="meter"><div id="bar"></div></div>
      <div id="status" class="muted">ëŒ€ê¸° ì¤‘â€¦</div>

      <div class="actions">
        <button id="analyze" class="btn btn-primary">ğŸ”® ê´€ìƒê¶í•© ë¶„ì„í•˜ê¸°</button>
        <button id="share" class="btn btn-outline">ğŸ”— ê²°ê³¼ ë§í¬ ë³µì‚¬</button>
      </div>
    </section>

    <!-- ê²°ê³¼ -->
    <section class="card" id="resultCard">
      <h2>ê²°ê³¼</h2>
      <div id="out" class="result">
        <div class="muted">ì•„ì§ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
      </div>

      <!-- ê³µìœ  í˜ì´ì§€ì—ì„œ ë³´ì´ëŠ” CTA -->
      <div id="shareCta" class="sharePanel" style="display:none">
        <a class="btn btn-cta" href="./" style="text-align:center;text-decoration:none">ğŸ ë¬´ë£Œë¡œ AI ê´€ìƒ ê¶í•© í•´ë³´ê¸°</a>
      </div>

      <div class="muted" style="margin-top:6px">(â€» ì˜¤ë½/ì°¸ê³ ìš© ê²°ê³¼ì…ë‹ˆë‹¤. ì‚¬ì§„ì€ ì €ì¥ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.)</div>
      <p style="text-align:center; font-size:12.5px; color:#8a94a7; margin:14px 0 4px">
        âœ‰ï¸ ë¬¸ì˜: <a href="mailto:dongja279@gmail.com" style="color:inherit">dongja279@gmail.com</a>
      </p>
    </section>
  </div>

  <script>
    /* ---------- DOM/ìƒíƒœ ---------- */
    const q = id => document.getElementById(id);
    const fileA=q('fileA'), fileB=q('fileB');
    const pickA=q('pickA'), pickB=q('pickB'), repA=q('replaceA'), repB=q('replaceB');
    const analyze=q('analyze'), shareBtn=q('share');
    const bar=q('bar'), statusEl=q('status'), out=q('out');
    const imgPA=q('imgPreviewA'), imgPB=q('imgPreviewB');
    const thumbA=q('thumbA'), thumbB=q('thumbB');
    const uploadCard=q('uploadCard'), shareCta=q('shareCta');
    let imgA=null, imgB=null, lastResult=null;

    /* ---------- ë°˜ì‘í˜• ì—…ë¡œë“œ ë¼ë²¨ ---------- */
    function relabel(){
      const w = window.innerWidth;
      pickA.textContent = w<340?'ğŸ‘¤ A ì—…ë¡œë“œ': w<390?'ğŸ‘¤ A ì‚¬ì§„ ì„ íƒ':'ğŸ‘¤ A ì‚¬ì§„ ì—…ë¡œë“œ';
      pickB.textContent = w<340?'ğŸ‘¤ B ì—…ë¡œë“œ': w<390?'ğŸ‘¤ B ì‚¬ì§„ ì„ íƒ':'ğŸ‘¤ B ì‚¬ì§„ ì—…ë¡œë“œ';
      const wrap = w < 330;
      pickA.style.whiteSpace = wrap?'normal':'nowrap';
      pickB.style.whiteSpace = wrap?'normal':'nowrap';
    }
    window.addEventListener('resize', relabel);
    document.addEventListener('DOMContentLoaded', relabel);

    /* ---------- ì—…ë¡œë“œ íŠ¸ë¦¬ê±° ---------- */
    pickA.onclick=()=>fileA.click();
    pickB.onclick=()=>fileB.click();
    repA.onclick =()=>fileA.click();
    repB.onclick =()=>fileB.click();

    fileA.onchange=e=>readPreview(e.target.files?.[0],'A');
    fileB.onchange=e=>readPreview(e.target.files?.[0],'B');

    async function readPreview(file,who){
      if(!file) return;
      const base64 = await toDataURL(file);
      const compressed = await compress(base64);
      if(who==='A'){ imgA=compressed; imgPA.src=compressed; thumbA.classList.add('has-image'); }
      else { imgB=compressed; imgPB.src=compressed; thumbB.classList.add('has-image'); }
    }
    function toDataURL(file){
      return new Promise((resolve,reject)=>{
        const r=new FileReader(); r.onload=()=>resolve(r.result); r.onerror=reject; r.readAsDataURL(file);
      });
    }
    function compress(src){
      return new Promise(resolve=>{
        const img=new Image();
        img.onload=()=>{
          const max=540; const s=Math.min(1, max/Math.max(img.width,img.height));
          const c=document.createElement('canvas'); c.width=img.width*s; c.height=img.height*s;
          c.getContext('2d').drawImage(img,0,0,c.width,c.height);
          resolve(c.toDataURL('image/jpeg',0.85));
        };
        img.src=src;
      });
    }

    /* ---------- ë¶„ì„ ì‹¤í–‰ ---------- */
    analyze.onclick=async()=>{
      if(!imgA||!imgB){ alert('A, B ì‚¬ì§„ì„ ëª¨ë‘ ì—…ë¡œë“œí•´ ì£¼ì„¸ìš”.'); return; }
      try{
        setBusy(true); statusEl.textContent='ë¶„ì„ì¤‘â€¦';
        out.innerHTML='<div class="muted">ë¶„ì„ì¤‘â€¦</div>';
        const res=await fetch('/api/match',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({imgA,imgB})});
        if(!res.ok){ const t=await res.text(); throw new Error(`HTTP ${res.status}: ${t}`); }
        const d=await res.json();
        lastResult=d;
        out.innerHTML = renderHTML(d);
        bar.style.width='100%'; statusEl.textContent='ë¶„ì„ì™„ë£Œ!';
      }catch(e){
        out.innerHTML=`<div class="section">ì—ëŸ¬: ${e?.message||e}</div>`;
        statusEl.textContent='ë¶„ì„ ì‹¤íŒ¨';
      }finally{ setBusy(false); }
    };

    function setBusy(b){
      bar.style.width=b?'70%':'0%';
      [analyze,pickA,pickB,repA,repB,shareBtn].forEach(el=>el.disabled=b);
    }

    /* ---------- ê²°ê³¼ ê³µìœ  (ë§í¬) ---------- */
    shareBtn.onclick = async () => {
      try{
        if(!lastResult){ alert('ë¨¼ì € ë¶„ì„ì„ ì™„ë£Œí•´ ì£¼ì„¸ìš”.'); return; }
        const url = makeShareURL(lastResult);
        await copyText(url);
        shareBtn.textContent='âœ… ë§í¬ ë³µì‚¬ë¨';
        setTimeout(()=>shareBtn.textContent='ğŸ”— ê²°ê³¼ ë§í¬ ë³µì‚¬',1200);
        if(navigator.share){ try{ await navigator.share({title:'AI ê´€ìƒê¶í•© ê²°ê³¼', url}); }catch{} }
      }catch{ alert('ë§í¬ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'); }
    };

    function makeShareURL(obj){
      const json = JSON.stringify(obj);
      const b64 = btoa(unescape(encodeURIComponent(json))); // UTF-8 safe
      return `${location.origin}${location.pathname}?r=${encodeURIComponent(b64)}`;
    }
    function parseShare(){
      const p = new URLSearchParams(location.search);
      const r = p.get('r'); if(!r) return null;
      try{ return JSON.parse(decodeURIComponent(escape(atob(r)))); }catch{return null;}
    }
    async function copyText(t){ await navigator.clipboard.writeText(t); }

    // ê³µìœ  URLë¡œ ì§„ì… ì‹œ ì½ê¸° ì „ìš© ë Œë”
    (function bootFromShare(){
      const data = parseShare();
      if(!data) return;
      lastResult=data;
      uploadCard.style.display='none';           // ì—…ë¡œë“œ ìˆ¨ê¹€
      shareCta.style.display='grid';             // CTA ë…¸ì¶œ
      out.innerHTML = renderHTML(data);
      statusEl.textContent='ë¶„ì„ì™„ë£Œ!';
      bar.style.width='100%';
    })();

    /* ---------- ë Œë”ëŸ¬ (ìš”ì²­ì‚¬í•­ ë°˜ì˜) ---------- */
    function renderHTML(d){
      const S = s=> (s??'').toString();
      const L = arr => (Array.isArray(arr)?arr:[arr]).filter(Boolean).map(x=>`<li>${S(x)}</li>`).join('');

      // ê°œì¸: ì¬ë¬¼/ì—°ì• /ê±´ê°•ë§Œ + ê·¼ê±° ìš”ì•½ + íŒ
      const fblock = (title, obj) => {
        if(!obj) return '';
        return `
          <div style="margin-top:8px">
            <div class="pill">${title}</div>
            ${obj.summary?`<div style="margin-top:6px">${S(obj.summary)}</div>`:''}
            ${obj.tips?`<ul class="list">${L(obj.tips)}</ul>`:''}
          </div>`;
      };
      const person = (label, p) => {
        if(!p) return '';
        const F = p.fortune || {}; // wealth/love/health
        return `
          <div class="who">
            <h4>${label}</h4>
            ${fblock('ì¬ë¬¼ìš´', F.wealth)}
            ${fblock('ì—°ì• ìš´', F.love)}
            ${fblock('ê±´ê°•ìš´', F.health)}
          </div>`;
      };

      const individuals = `
        <div class="section">
          <h3>ğŸ‘¥ ê°œì¸ë³„ ê´€ìƒ íŠ¹ì§• & ìš´ì„¸</h3>
          <div class="pair">
            ${person('A', d.personA||d.person1)}
            ${person('B', d.personB||d.person2)}
          </div>
        </div>`;

      // ê¶í•©: 1) ì—°ì• /ìš°ì • 2) ë¹„ì¦ˆë‹ˆìŠ¤
      const c = d.compatibility||{};
      const block = (title, obj) => !obj ? '' : `
        <div class="scoreCard">
          <div class="scoreTitle">
            <b>${title}</b>
            <div class="badge">${obj.score ?? '?'}</div>
          </div>
          ${obj.summary?`<div class="pill" style="display:inline-block;margin-bottom:8px">${S(obj.summary)}</div>`:''}
          ${obj.strengths?`<div><b>â€¢ ì˜ ë§ëŠ” ì </b><ul class="list">${L(obj.strengths)}</ul></div>`:''}
          ${obj.cautions?`<div style="margin-top:6px"><b>â€¢ ì¡°ì‹¬í•´ì•¼ í•  ì </b><ul class="list">${L(obj.cautions)}</ul></div>`:''}
        </div>`;

      const compat = `
        <div class="section">
          <h3>ğŸ”— ê¶í•© í•´ì„</h3>
          <div class="scoreRow">
            ${block('1) ì—°ì• /ìš°ì •', c.romance_friendship || c.love_friendship)}
            ${block('2) ë¹„ì¦ˆë‹ˆìŠ¤', c.business)}
          </div>
        </div>`;

      return `${individuals}${compat}`;
    }
  </script>
</body>
</html>
