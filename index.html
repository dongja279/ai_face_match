<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>AI 관상궁합</title>
<style>
  :root{
    --bg:#0b1220; --panel:#0f1629; --ink:#ebf1ff; --muted:#9fb0c8; --line:#1c2942;
    --accent1:#6c5ce7; --accent2:#00d2ff; --good:#22c55e; --warn:#f59e0b; --bad:#ef4444;
  }
  body{margin:0;background:var(--bg);color:var(--ink);font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,Helvetica,Arial}
  .wrap{max-width:980px;margin:0 auto;padding:16px}
  header{display:flex;gap:12px;align-items:center;margin:6px 0 18px}
  header .logo{width:40px;height:40px;border-radius:12px;background:conic-gradient(from 180deg,var(--accent1),var(--accent2))}
  header h1{margin:0;font-size:22px}
  header p{margin:0;color:var(--muted);font-size:13px}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:16px;margin-bottom:16px}
  .grid{display:grid;gap:16px}
  @media(min-width:800px){.grid.up{grid-template-columns:1fr 1fr}}
  .slot{background:#0b1326;border:1px dashed #2a3a61;border-radius:14px;position:relative;overflow:hidden}
  .slot img{display:block;width:100%;height:auto}
  .slot .btn{
    position:absolute;left:50%;bottom:12px;transform:translateX(-50%);
    background:linear-gradient(135deg,var(--accent1),var(--accent2));
    color:#fff;border:none;border-radius:12px;padding:12px 16px;font-weight:800;cursor:pointer
  }
  .actions{display:flex;gap:12px;justify-content:center;margin-top:12px;flex-wrap:wrap}
  .btn{
    background:#15223c;border:1px solid #23345a;color:var(--ink);border-radius:12px;padding:14px 18px;font-weight:800;cursor:pointer
  }
  .btn.primary{background:linear-gradient(135deg,var(--accent1),var(--accent2));color:#fff;border:none}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  /* 진행률 */
  .progress{width:100%;height:14px;background:#0e1a33;border:1px solid #23345a;border-radius:999px;overflow:hidden;margin:10px 0 4px}
  .bar{height:100%;width:0%;background:linear-gradient(90deg,var(--accent2),var(--accent1));display:flex;align-items:center;justify-content:center;color:#001426;font-size:11px;font-weight:800;transition:width .25s}
  .ptext{color:var(--muted);font-size:12px;text-align:center;margin:0 0 2px}
  /* 결과 */
  .section{background:#0c152b;border:1px solid #23345a;border-radius:14px;padding:14px;margin-top:12px}
  .title{display:flex;align-items:center;gap:10px;margin:0 0 10px;font-size:18px}
  .pill{display:inline-block;background:#0f1f3e;border:1px solid #213761;border-radius:999px;padding:4px 10px;font-weight:700;margin-right:8px}
  .scoreWrap{display:flex;align-items:center;gap:12px}
  .badge{width:54px;height:54px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,var(--accent2),var(--accent1));font-size:20px;font-weight:900}
  ul.clean{margin:6px 0 0 20px}
  ul.clean li{margin:4px 0}
  footer{margin:18px 0;color:#9fb0c8;font-size:12px;text-align:center}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="logo" aria-hidden="true"></div>
    <div>
      <h1>AI 관상궁합</h1>
      <p>두 사람의 얼굴 사진을 업로드하면, 심층 궁합 분석을 제공합니다. (재미로만 보세요!)</p>
    </div>
  </header>

  <!-- 업로드 -->
  <div class="card">
    <h3 style="margin:0 0 10px">사진 업로드</h3>
    <div class="grid up">
      <div class="slot" id="slotA">
        <img id="imgA" alt="A 미리보기" style="display:none">
        <input id="fileA" type="file" accept="image/*" capture="environment" hidden>
        <button class="btn" id="btnA">A 사진 업로드</button>
      </div>
      <div class="slot" id="slotB">
        <img id="imgB" alt="B 미리보기" style="display:none">
        <input id="fileB" type="file" accept="image/*" capture="environment" hidden>
        <button class="btn" id="btnB">B 사진 업로드</button>
      </div>
    </div>

    <!-- 진행률 바 -->
    <div class="progress"><div id="pbar" class="bar">0%</div></div>
    <p id="ptext" class="ptext">대기 중…</p>

    <!-- 액션 버튼(가운데 정렬) -->
    <div class="actions">
      <button id="analyze" class="btn primary" disabled>🔮 관상궁합 분석하기</button>
      <button id="share" class="btn" disabled>📋 분석 결과 복사하기(링크)</button>
    </div>
  </div>

  <!-- 결과 -->
  <div id="result"></div>

  <footer>✉️ 문의: <a href="mailto:dongja279@gmail.com" style="color:#a7c8ff">dongja279@gmail.com</a></footer>
</div>

<script>
  // ===== 미리보기/업로드 =====
  const imgAEl = document.getElementById('imgA');
  const imgBEl = document.getElementById('imgB');
  const fileA = document.getElementById('fileA');
  const fileB = document.getElementById('fileB');
  const btnA = document.getElementById('btnA');
  const btnB = document.getElementById('btnB');
  const analyzeBtn = document.getElementById('analyze');
  const shareBtn = document.getElementById('share');
  const resultEl = document.getElementById('result');

  let imgAData = null;
  let imgBData = null;

  btnA.onclick = ()=> fileA.click();
  btnB.onclick = ()=> fileB.click();

  fileA.onchange = async(e)=> { imgAData = await readAsDataURL(e.target.files[0]); setPreview(imgAEl, imgAData); gate(); };
  fileB.onchange = async(e)=> { imgBData = await readAsDataURL(e.target.files[0]); setPreview(imgBEl, imgBData); gate(); };

  function setPreview(imgEl, data){
    imgEl.src = data; imgEl.style.display='block';
  }
  function readAsDataURL(f){
    return new Promise((res,rej)=>{ if(!f){res(null);return;}
      const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(f);
    });
  }
  function gate(){ analyzeBtn.disabled = !(imgAData && imgBData); }

  // ===== 진행률 UI =====
  const pbar = document.getElementById('pbar');
  const ptext = document.getElementById('ptext');
  function progress(p, msg){
    const v = Math.max(0, Math.min(100, Math.round(p)));
    pbar.style.width = v + '%';
    pbar.textContent = v + '%';
    ptext.textContent = msg || '';
  }
  function lockUI(on){
    [btnA,btnB,analyzeBtn,shareBtn,fileA,fileB].forEach(el=> el.disabled = on ? true : false);
  }

  // ===== 분석 버튼 =====
  analyzeBtn.onclick = async () => {
    if(!imgAData || !imgBData) return;
    try{
      lockUI(true);
      progress(10, '이미지 준비 중…');
      await sleep(200);

      progress(20, '이미지 업로드 중…');
      await sleep(200);

      progress(35, 'AI 요청 구성 중…');
      const payload = { imgA: imgAData, imgB: imgBData };
      await sleep(150);

      progress(55, 'AI가 관상을 세밀 분석 중… (잠시만요)');
      const res = await fetch('/api/match', {
        method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)
      });

      progress(75, '결과 정리 중…');
      if(!res.ok){
        const e = await res.text().catch(()=> 'Server error');
        throw new Error(e || ('HTTP '+res.status));
      }
      const data = await res.json();

      progress(95, '렌더링…');
      render(data);
      progress(100, '분석완료!');
      shareBtn.disabled = false;
    }catch(err){
      alert('분석 중 오류가 발생했습니다.');
      console.error(err);
    }finally{
      lockUI(false);
    }
  };

  // ===== 공유(링크 복사) =====
  shareBtn.onclick = async ()=>{
    try{
      const url = window.location.href; // (KV 링크를 쓰는 버전이라면 여기서 생성한 링크를 사용)
      await navigator.clipboard.writeText(url);
      shareBtn.textContent = '✅ 링크 복사됨';
      setTimeout(()=>shareBtn.textContent='📋 분석 결과 복사하기(링크)',1200);
    }catch{
      alert('클립보드 복사가 차단되었습니다. 주소창의 링크를 복사해 주세요.');
    }
  };

  // ===== 결과 렌더링 =====
  function render(d){
    // 안전 접근 헬퍼
    const s = (v)=> v==null ? '' : String(v);
    const list = (arr)=> (arr||[]).map(t=>`<li>${s(t)}</li>`).join('');

    resultEl.innerHTML = `
      <div class="card">
        <h3 class="title">👤 개인별 관상 특징 & 운세</h3>
        <div class="section"><div class="pill">A</div>
          ${personBlock(d.personA)}
        </div>
        <div class="section"><div class="pill">B</div>
          ${personBlock(d.personB)}
        </div>
      </div>

      ${compatBlock('💖 연애/우정', d.compatibility?.love_friendship)}
      ${compatBlock('💼 비즈니스', d.compatibility?.business)}
    `;
  }

  function personBlock(p){
    if(!p) return '<div class="muted">데이터 없음</div>';
    return `
      <div class="section">
        <div class="pill">재물운</div>
        <div><b>근거:</b> ${escapeHTML(p.wealth?.reason||'')}</div>
        <div><b>결론:</b> ${escapeHTML(p.wealth?.verdict||'')}</div>
        ${tipsList(p.wealth?.tips)}
      </div>
      <div class="section">
        <div class="pill">연애운</div>
        <div><b>근거:</b> ${escapeHTML(p.love?.reason||'')}</div>
        <div><b>결론:</b> ${escapeHTML(p.love?.verdict||'')}</div>
        ${tipsList(p.love?.tips)}
      </div>
      <div class="section">
        <div class="pill">건강운</div>
        <div><b>근거:</b> ${escapeHTML(p.health?.reason||'')}</div>
        <div><b>결론:</b> ${escapeHTML(p.health?.verdict||'')}</div>
        ${tipsList(p.health?.tips)}
      </div>
    `;
  }
  function tipsList(arr){
    if(!arr || !arr.length) return '';
    return `<ul class="clean">${arr.map(t=>`<li>${escapeHTML(t)}</li>`).join('')}</ul>`;
  }
  function compatBlock(title, data){
    if(!data) return '';
    return `
      <div class="card">
        <div class="title">
          <div class="badge">${Number(data.score||0)}</div>
          <div>${title}</div>
        </div>
        <div class="section">
          <div class="pill">잘 맞는 점</div>
          <ul class="clean">${(data.strengths||[]).map(t=>`<li>${escapeHTML(t)}</li>`).join('')}</ul>
        </div>
        <div class="section">
          <div class="pill">조심해야 할 점</div>
          <ul class="clean">${(data.cautions||[]).map(t=>`<li>${escapeHTML(t)}</li>`).join('')}</ul>
        </div>
      </div>
    `;
  }

  function escapeHTML(str){ return s(str).replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
  function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }
</script>
</body>
</html>