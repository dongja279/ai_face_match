<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>AI 관상궁합</title>
<style>
  :root{
    --bg:#0f1220; --panel:#11162a; --ink:#e8eef7; --muted:#9fb0c6;
    --line:#1e263a; --accent:#7c5cff; --accent2:#22d3ee; --chip:#0d1222;
    --good:#10b981; --btn:#0b1324;
  }
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--ink);font-family:-apple-system,BlinkMacSystemFont,"Noto Sans KR",Segoe UI,Roboto,Helvetica,Arial}
  .wrap{max-width:980px;margin:24px auto;padding:0 16px}
  header{margin-bottom:14px}
  h1{margin:0 0 6px;font-size:28px}
  .sub{color:var(--muted)}
  .grid{display:grid;gap:16px}
  @media(min-width:900px){.grid{grid-template-columns:340px 1fr}}
  .card{background:linear-gradient(180deg,var(--panel),#0e1427);border:1px solid var(--line);border-radius:16px;padding:16px}
  .card h2{margin:0 0 12px;font-size:16px;color:#cfe1ff}
  .uploader{display:grid;grid-template-columns:1fr 1fr;gap:14px}
  .slot{background:#0b1222;border:1px dashed #304061;border-radius:14px;min-height:220px;display:flex;align-items:flex-end;justify-content:center;padding:14px;position:relative;overflow:hidden}
  .slot img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
  input[type=file]{display:none}
  .btn{border:1px solid #2a3654;background:linear-gradient(135deg,#324064,#29324b);color:#eaf2ff;border-radius:12px;padding:12px 14px;font-weight:800;cursor:pointer;width:88%;text-align:center}
  .primary{background:linear-gradient(135deg,var(--accent),var(--accent2));border:none;color:#fff}
  .primary:disabled{opacity:.6}
  .act{display:grid;gap:10px;margin-top:14px}
  .bar{height:6px;border-radius:999px;background:#0a1221;border:1px solid #1b2a45;overflow:hidden}
  .bar>div{height:100%;width:0%;background:linear-gradient(90deg,#22d3ee,#7c5cff,#22c55e)}
  .muted{color:var(--muted)}
  .pill{display:inline-block;background:#0f1a30;border:1px solid #253356;color:#b6c7e6;padding:4px 8px;border-radius:999px;font-size:12px}
  .list{margin:6px 0 0 0;padding-left:18px}
  .section{background:#0d1326;border:1px solid #1d2947;border-radius:14px;padding:14px;margin:14px 0}
  .who h4{margin:0 0 8px}
  .pair{display:grid;gap:10px}
  @media(min-width:760px){.pair{grid-template-columns:1fr 1fr}}
  footer{margin-top:18px;color:#a9bad7}
  a.email{color:#cfe1ff}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>AI 관상궁합</h1>
    <div class="sub">두 사람의 얼굴 사진을 업로드하면, 심층 궁합 분석을 제공합니다. (재미로만 보세요!)</div>
  </header>

  <div class="grid">
    <!-- 좌: 업로드 -->
    <section class="card">
      <h2>사진 업로드</h2>
      <div class="uploader">
        <div class="slot">
          <img id="imgPrevA" alt="" style="display:none" />
          <input id="fileA" type="file" accept="image/*">
          <button id="btnA" class="btn" type="button">🧑 A 사진 업로드</button>
        </div>
        <div class="slot">
          <img id="imgPrevB" alt="" style="display:none" />
          <input id="fileB" type="file" accept="image/*">
          <button id="btnB" class="btn" type="button">👩 B 사진 업로드</button>
        </div>
      </div>

      <div style="margin-top:12px">
        <div class="bar"><div id="bar"></div></div>
        <div id="status" class="muted" style="margin-top:6px">대기 중…</div>
      </div>

      <div class="act">
        <button id="analyze" class="primary btn" type="button">🔮 관상궁합 분석하기</button>
        <button id="shareBtn" class="btn" type="button">📋 분석 결과 복사하기(링크)</button>
      </div>
    </section>

    <!-- 우: 결과 -->
    <section class="card">
      <h2>결과</h2>
      <div id="out" class="muted">아직 결과가 없습니다.</div>
      <div id="shareCta" style="display:none;margin-top:8px" class="act">
        <a class="primary btn" href="/" style="text-decoration:none;text-align:center">무료로 AI 관상 궁합</a>
      </div>
    </section>
  </div>

  <footer>문의: <a class="email" href="mailto:dongja279@gmail.com">dongja279@gmail.com</a></footer>
</div>

<script>
  const fileA=document.getElementById('fileA'), fileB=document.getElementById('fileB');
  const btnA=document.getElementById('btnA'), btnB=document.getElementById('btnB');
  const imgPrevA=document.getElementById('imgPrevA'), imgPrevB=document.getElementById('imgPrevB');
  const analyze=document.getElementById('analyze'), out=document.getElementById('out');
  const bar=document.getElementById('bar'), statusEl=document.getElementById('status');
  const shareBtn=document.getElementById('shareBtn'), shareCta=document.getElementById('shareCta');
  let imgA=null, imgB=null, busy=false, lastResult=null;

  btnA.onclick=()=>fileA.click(); btnB.onclick=()=>fileB.click();
  fileA.onchange=()=>preview(fileA, imgPrevA, v=>imgA=v);
  fileB.onchange=()=>preview(fileB, imgPrevB, v=>imgB=v);

  function preview(inp, imgEl, setter){
    const f = inp.files?.[0]; if(!f) return;
    const r = new FileReader();
    r.onload = e => { setter(e.target.result); imgEl.src=e.target.result; imgEl.style.display='block'; };
    r.readAsDataURL(f);
  }

  function setBusy(b, msg){
    busy=b;
    statusEl.textContent = b ? (msg || '분석중..') : '분석완료!';
    bar.style.width = b ? '70%' : '100%';
    analyze.disabled = b; btnA.disabled=b; btnB.disabled=b;
  }

  analyze.onclick = async ()=>{
    if(!imgA || !imgB){ alert('A, B 사진을 모두 업로드해 주세요.'); return; }
    try{
      setBusy(true,'분석중..');
      out.innerHTML = '<div class="muted">AI가 관상 분석 중…</div>';

      const r = await fetch('/api/match',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ imgA, imgB })
      });
      if(!r.ok) throw new Error(await r.text());
      const d = await r.json();
      lastResult = d;
      out.innerHTML = renderHTML(d);
    }catch(e){
      out.innerHTML = `<div class="section">에러: ${e?.message||e}</div>`;
    }finally{
      setBusy(false,'분석완료!');
    }
  };

  // reason/verdict/tips UI
  const fblock = (title, obj)=>{
    if(!obj) return '';
    const R = s => (s ?? '').toString();
    const L = a => (Array.isArray(a)?a:[a]).filter(Boolean).map(x=>`<li>${R(x)}</li>`).join('');
    return `
      <div style="margin-top:10px">
        <div class="pill">${title}</div>
        ${obj.reason ? `<div style="margin-top:6px"><b>근거:</b> ${R(obj.reason)}</div>` : ''}
        ${obj.verdict ? `<div style="margin-top:6px"><b>결론:</b> ${R(obj.verdict)}</div>` : ''}
        ${obj.tips ? `<ul class="list">${L(obj.tips)}</ul>` : ''}
      </div>`;
  };

  function person(label, p){
    const F = p?.fortune || {};
    return `
    <div class="who section">
      <h4>${label}</h4>
      ${fblock('재물운', F.wealth)}
      ${fblock('연애운', F.love)}
      ${fblock('건강운', F.health)}
    </div>`;
  }

  function compat(title, data){
    const R = s => (s ?? '').toString();
    const L = a => (Array.isArray(a)?a:[a]).filter(Boolean).map(x=>`<li>${R(x)}</li>`).join('');
    return `
      <div class="section">
        <div class="pill">${title} ${R(data?.score)}점</div>
        <div style="margin-top:8px"><b>잘 맞는 점</b></div>
        <ul class="list">${L(data?.strengths)}</ul>
        <div style="margin-top:8px"><b>조심해야 할 점</b></div>
        <ul class="list">${L(data?.cautions)}</ul>
      </div>`;
  }

  function renderHTML(d){
    return `
    <div class="section" style="background:#0b162d">
      <div class="pill">✨ 궁합 요약</div>
      <div class="muted" style="margin-top:6px">분석완료! 아래에서 개인 운세 근거와 궁합 해석을 확인하세요.</div>
    </div>
    <div class="pair">
      ${person('A', d.personA)}
      ${person('B', d.personB)}
    </div>
    ${compat('💖 연애/우정', d?.compatibility?.love_friendship)}
    ${compat('💼 비즈니스', d?.compatibility?.business)}
    `;
  }

  // 공유(짧은 링크)
  shareBtn.onclick = async ()=>{
    try{
      if(!lastResult){ alert('먼저 분석을 완료해 주세요.'); return; }
      const r = await fetch('/api/share', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ result: lastResult })
      });
      if(!r.ok) throw new Error(await r.text());
      const { id } = await r.json();
      const url = `${location.origin}/v?id=${id}`;
      await navigator.clipboard.writeText(url);
      shareBtn.textContent = '✅ 링크 복사됨';
      setTimeout(()=> shareBtn.textContent='📋 분석 결과 복사하기(링크)', 1200);
      if(navigator.share){ try{ await navigator.share({ title:'AI 관상궁합 결과', url }); }catch{} }
    }catch(e){ alert('링크 복사 실패: '+(e?.message||e)); }
  };

  // 공유 링크로 진입하면 결과 렌더
  (function bootFromShare(){
    const id = new URLSearchParams(location.search).get('id');
    if(!id) return;
    fetch(`/api/get?id=${encodeURIComponent(id)}`)
      .then(r=> r.ok ? r.json() : Promise.reject('not found'))
      .then(data=>{
        lastResult=data;
        document.getElementById('shareCta').style.display='grid';
        document.querySelector('.uploader').style.display='none';
        out.innerHTML = renderHTML(data);
        statusEl.textContent = '분석완료!';
        bar.style.width = '100%';
      })
      .catch(()=>{});
  })();
</script>
</body>
</html>

<!-- updated for 관상 근거 -->

