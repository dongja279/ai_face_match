<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AI ê´€ìƒê¶í•© â€” ë‘ ì‚¬ì§„ìœ¼ë¡œ ë³´ëŠ” ìš°ë¦¬ ì‚¬ì´</title>
  <style>
    :root{ --bg:#0e1116; --panel:#141922; --panel2:#0f1520; --ink:#e8eef7; --muted:#9fb1c8; --line:#1f2937; --chip:#1b2230; --accent:#8b5cf6; --accent2:#06b6d4; }
    @media (prefers-color-scheme: light){ :root{ --bg:#f7f9fc; --panel:#ffffff; --panel2:#ffffff; --ink:#202734; --muted:#667085; --line:#e7edf5; --chip:#f2f6fc; --accent:#6d28d9; --accent2:#0891b2; } }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:-apple-system,BlinkMacSystemFont,"Apple SD Gothic Neo","Noto Sans KR",Segoe UI,Roboto,Helvetica,Arial}
    header{position:sticky;top:0;z-index:10;background:linear-gradient(90deg,#131a25cc,#0f1520cc);border-bottom:1px solid #ffffff14;color:#fff;backdrop-filter:blur(8px)}
    .container{max-width:1100px;margin:0 auto;padding:16px}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:36px;height:36px;border-radius:50%;background:conic-gradient(from 140deg,var(--accent),var(--accent2))}
    .brand h1{margin:0;font-size:18px}
    .brand small{display:block;color:#cfe1ff}
    main{max-width:1100px;margin:20px auto;padding:0 16px;display:grid;gap:16px}
    .grid{display:grid;gap:16px} @media(min-width:980px){.grid{grid-template-columns:390px 1fr}}
    .panel{background:linear-gradient(180deg,var(--panel),var(--panel2));border:1px solid var(--line);border-radius:16px;padding:16px}
    .panel h2{margin:0 0 10px;color:#b8c3d6;font-size:14px}
    .uploader{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media(max-width:560px){ .uploader{grid-template-columns:1fr} }
    .btn{cursor:pointer;border:none;border-radius:12px;padding:12px 14px;font-weight:800;background:linear-gradient(135deg,var(--accent),var(--accent2));color:#fff}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .soft{background:var(--chip);border:1px solid var(--line);color:var(--ink)}
    .meter{height:8px;background:#0f1623;border-radius:999px;overflow:hidden;border:1px solid #ffffff16;margin-top:10px}
    .meter>div{height:100%;width:0%;background:linear-gradient(90deg,#22d3ee,#a78bfa,#22c55e)}
    .thumbs{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
    .box{border:1px dashed #89a3c91f;border-radius:14px;min-height:160px;display:flex;align-items:center;justify-content:center;background:#0f172a;color:#94a3b8}
    .thumbs img{width:100%;border-radius:12px;display:block}
    .result{white-space:pre-wrap;background:#0f1623;color:#e7efff;border:1px solid #ffffff17;border-radius:14px;padding:16px;margin-top:12px}
    footer{max-width:1100px;margin:18px auto 30px;padding:0 16px;color:var(--muted);font-size:12px;text-align:center}
    footer a{color:inherit}
  </style>
</head>
<body>
  <header>
    <div class="container brand">
      <div class="logo" aria-hidden="true"></div>
      <div>
        <h1>AI ê´€ìƒê¶í•©</h1>
        <small>ë‘ ì‚¬ëŒì˜ ì–¼êµ´ ì‚¬ì§„ìœ¼ë¡œ ë³´ëŠ” ìš°ë¦¬ ì‚¬ì´ â€” ì¬ë¯¸ë¡œë§Œ ë³´ì„¸ìš”!</small>
      </div>
    </div>
  </header>

  <main class="grid">
    <section class="panel">
      <h2>ì‚¬ì§„ ì—…ë¡œë“œ</h2>
      <div class="uploader">
        <div>
          <input id="fileA" type="file" accept="image/*" hidden>
          <button id="btnA" class="btn" type="button">ğŸ‘¤ A ì‚¬ì§„ ì—…ë¡œë“œ</button>
        </div>
        <div>
          <input id="fileB" type="file" accept="image/*" hidden>
          <button id="btnB" class="btn" type="button">ğŸ‘¤ B ì‚¬ì§„ ì—…ë¡œë“œ</button>
        </div>
      </div>
      <div class="meter"><div id="bar"></div></div>
      <div id="status" style="color:var(--muted);font-size:12px;margin-top:6px">ëŒ€ê¸° ì¤‘â€¦</div>
      <div class="thumbs">
        <div class="box" id="boxA">A ë¯¸ë¦¬ë³´ê¸°</div>
        <div class="box" id="boxB">B ë¯¸ë¦¬ë³´ê¸°</div>
      </div>
      <button id="analyze" class="btn" style="width:100%;margin-top:12px">ğŸ”® ê´€ìƒê¶í•© ë¶„ì„í•˜ê¸°</button>
      <button id="demo" class="soft" style="width:100%;margin-top:8px">ğŸ’¾ ë°ëª¨ ì´ë¯¸ì§€ë¡œ í…ŒìŠ¤íŠ¸</button>
    </section>

    <section class="panel">
      <h2>ê²°ê³¼</h2>
      <div id="out" class="result">ì•„ì§ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
    </section>
  </main>

  <footer>ë¬¸ì˜: <a href="mailto:dongja279@gmail.com">dongja279@gmail.com</a></footer>

  <script>
    // ===== DOM =====
    const q = id => document.getElementById(id);
    const fileA=q('fileA'), fileB=q('fileB');
    const btnA=q('btnA'), btnB=q('btnB'), analyze=q('analyze'), demo=q('demo');
    const boxA=q('boxA'), boxB=q('boxB'), out=q('out');
    const bar=q('bar'), statusEl=q('status');

    let imgA=null, imgB=null, busy=false;

    btnA.onclick=()=>fileA.click();
    btnB.onclick=()=>fileB.click();

    fileA.onchange=e=>readAndPreview(e.target.files?.[0],'A');
    fileB.onchange=e=>readAndPreview(e.target.files?.[0],'B');

    // ë‚´ì¥ ë°ëª¨(ë„¤íŠ¸ì›Œí¬ ì—†ì´ ë™ì‘í•˜ëŠ” ì‘ì€ PNG ì‹¤ë£¨ì—£)
    demo.onclick=()=>{
      const demoA='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAQAAACq...'; // ì„ì˜ ìƒ˜í”Œ
      const demoB='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAQAAACq...';
      imgA=demoA; imgB=demoB; preview(demoA,'A'); preview(demoB,'B');
    };

    function setBusy(b,msg){ busy=b; statusEl.textContent=b?(msg||'ë¶„ì„ ì¤‘â€¦'):'ëŒ€ê¸° ì¤‘â€¦'; bar.style.width=b?'70%':'0%'; analyze.disabled=b; btnA.disabled=b; btnB.disabled=b; }

    function readAndPreview(file,who){
      if(!file) return;
      const r=new FileReader();
      r.onload=ev=>compressToCanvas(ev.target.result, who);
      r.readAsDataURL(file);
    }

    function compressToCanvas(src,who){
      const img=new Image();
      img.onload=()=>{
        const max=420; const scale=Math.min(1, max/Math.max(img.width,img.height));
        const c=document.createElement('canvas'); c.width=img.width*scale; c.height=img.height*scale;
        const ctx=c.getContext('2d'); ctx.drawImage(img,0,0,c.width,c.height);
        const data=c.toDataURL('image/jpeg',0.85);
        if(who==='A'){ imgA=data; } else { imgB=data; }
        preview(data,who);
      }; img.src=src;
    }

    function preview(data,who){
      const el=who==='A'?boxA:boxB;
      el.innerHTML='';
      const im=new Image(); im.src=data; im.style.borderRadius='12px'; im.style.width='100%';
      el.appendChild(im);
    }

    analyze.onclick=async()=>{
      if(!imgA||!imgB){ alert('A, B ì‚¬ì§„ì„ ëª¨ë‘ ì—…ë¡œë“œí•´ ì£¼ì„¸ìš”.'); return; }
      try{
        setBusy(true,'ê´€ìƒê¶í•© ë¶„ì„ ì¤‘â€¦'); out.textContent='';
        const res=await fetch('/api/match',{ method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ imgA, imgB }) });
        if(!res.ok){ const t=await res.text(); throw new Error(`HTTP ${res.status}: ${t}`); }
        const data=await res.json();
        out.innerHTML = renderResult(data);
        bar.style.width='100%'; statusEl.textContent='ì™„ë£Œ!';
      }catch(e){ out.textContent='ì—ëŸ¬: '+(e?.message||e); }
      finally{ setBusy(false); }
    };

    // ===== ì•ˆì „ ë¬¸ìì—´í™”: [object Object] ë°©ì§€ & ì˜ˆì˜ê²Œ í¼ì¹˜ê¸°
    function s(v){
      if(v == null) return '';
      if(Array.isArray(v)) return v.map(x=>`- ${x}`).join('\n');
      if(typeof v === 'object'){
        const map = {
          face_shape:'ì–¼êµ´í˜•', forehead:'ì´ë§ˆ', eyebrows:'ëˆˆì¹', eyes:'ëˆˆ',
          nose:'ì½”', mouth_lips:'ì…/ì…ìˆ ', ears:'ê·€', jaw_chin:'í„±/í„±ì„ ', skin_expression:'í”¼ë¶€/í‘œì •'
        };
        return Object.entries(v)
          .filter(([,val]) => val != null && String(val).trim() !== '')
          .map(([k,val]) => `- ${map[k] || k}: ${val}`)
          .join('\n');
      }
      return String(v);
    }

    // ===== ê²°ê³¼ ë Œë”ëŸ¬(ì ìˆ˜ + ê°œì¸ë³„ ì„¸ë¶€ + ê¶í•© ê°•ì /ì£¼ì˜/íŒ)
    function renderResult(d){
      const lines=[];
      lines.push(`âœ¨ ê¶í•© ì ìˆ˜: <b>${d.score ?? '?'}</b> / 100`);
      if(d.score_reason) lines.push(`(ì ìˆ˜ ê·¼ê±°) ${s(d.score_reason)}`);

      lines.push('\nâ€”â€” ê°œì¸ë³„ ê´€ìƒ íŠ¹ì§• â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”');
      if(d.personA || d.person1){
        const A = d.personA || d.person1;
        lines.push(`A) ${s(A.summary || A.overall)}`);
        if(A.features) lines.push(s(A.features));
        else {
          // person1 ìŠ¤í‚¤ë§ˆ(eyes/nose/mouth/ears ë“±)ë„ ì§€ì›
          const part = {eyes:A.eyes, nose:A.nose, mouth_lips:A.mouth||A.mouth_lips, ears:A.ears, face_shape:A.face_shape, forehead:A.forehead, eyebrows:A.eyebrows, jaw_chin:A.jaw_chin, skin_expression:A.skin_expression};
          lines.push(s(part));
        }
        if(A.analysis) lines.push(`- í’€ì´: ${s(A.analysis)}`);
      }
      lines.push('');
      if(d.personB || d.person2){
        const B = d.personB || d.person2;
        lines.push(`B) ${s(B.summary || B.overall)}`);
        if(B.features) lines.push(s(B.features));
        else {
          const part = {eyes:B.eyes, nose:B.nose, mouth_lips:B.mouth||B.mouth_lips, ears:B.ears, face_shape:B.face_shape, forehead:B.forehead, eyebrows:B.eyebrows, jaw_chin:B.jaw_chin, skin_expression:B.skin_expression};
          lines.push(s(part));
        }
        if(B.analysis) lines.push(`- í’€ì´: ${s(B.analysis)}`);
      }

      lines.push('\nâ€”â€” ê¶í•© í•´ì„ â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”');
      if(d.compatibility?.summary) lines.push(s(d.compatibility.summary));
      if(d.compatibility?.strengths?.length || typeof d.compatibility?.strengths === 'string'){
        lines.push('\nì˜ ë§ëŠ” ì :'); lines.push(s(d.compatibility.strengths));
      }
      if(d.compatibility?.cautions?.length || typeof d.compatibility?.cautions === 'string'){
        lines.push('\nì¡°ì‹¬í•´ì•¼ í•  ì :'); lines.push(s(d.compatibility.cautions));
      }
      if(d.compatibility?.tips?.length || typeof d.compatibility?.tips === 'string'){
        lines.push('\nTip:'); lines.push(s(d.compatibility.tips));
      }

      lines.push('\n(â€» ì˜¤ë½/ì°¸ê³ ìš© ê²°ê³¼ì…ë‹ˆë‹¤. ì‚¬ì§„ì€ ì €ì¥ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.)');
      return lines.join('\n');
    }
  </script>
</body>
</html>
