<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>AI 관상궁합</title>
<style>
  body { font-family: sans-serif; padding: 20px; background: #f0f2f5; }
  .container { max-width: 600px; margin: auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
  h1 { text-align: center; margin-bottom: 10px; }
  p { text-align: center; color: #555; font-size: 0.9rem; }

  /* 사진 업로드 & 미리보기 영역 */
  .preview-section {
    display: flex;
    gap: 10px;
    justify-content: center;
    margin-bottom: 15px;
  }
  .preview-box {
    flex: 1;
    aspect-ratio: 3/4;
    background: #0b1220;
    border-radius: 8px;
    overflow: hidden;
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
  }
  .preview-box img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  .upload-btn {
    position: absolute;
    background: linear-gradient(135deg,#6ea8ff,#7c6dff);
    color: white;
    padding: 6px 10px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.8rem;
    bottom: 8px;
    left: 50%;
    transform: translateX(-50%);
    opacity: 0.9;
  }

  /* 버튼 그룹 */
  .button-group {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-top: 15px;
  }
  button { font-size: 1rem; font-weight: bold; padding: 12px; border: none; border-radius: 8px; cursor: pointer; }
  .analyze-btn { background: linear-gradient(135deg,#6ea8ff,#7c6dff); color: white; }
  .copy-btn { background: #059669; color: white; }

  /* 결과 영역 */
  .result { font-size:15.5px; line-height:1.7; letter-spacing:.1px; white-space: pre-line; padding: 15px; border-radius: 8px; margin-top: 20px; background: #0b1220; color: #eef4ff; }
  @media(min-width:390px){ .result{ font-size:16px; } }

  .result h3 { color:#fff; margin-top: 1em; }
  .result b { color:#fff; }
  .muted{ color:#b9c7de; }
</style>
</head>
<body>
<div class="container">
  <h1>AI 관상궁합</h1>
  <p>두 사람의 얼굴 사진을 업로드하면, 심층 궁합 분석을 제공합니다. (재미로만 보세요!)</p>

  <div class="preview-section">
    <div class="preview-box" id="previewA">
      A
      <input type="file" id="imgA" accept="image/*" style="display:none" onchange="showPreview('A')">
      <button class="upload-btn" onclick="document.getElementById('imgA').click()">A 사진 업로드</button>
    </div>
    <div class="preview-box" id="previewB">
      B
      <input type="file" id="imgB" accept="image/*" style="display:none" onchange="showPreview('B')">
      <button class="upload-btn" onclick="document.getElementById('imgB').click()">B 사진 업로드</button>
    </div>
  </div>

  <div class="button-group">
    <button class="analyze-btn" onclick="analyze()">🔮 관상궁합 분석하기</button>
    <button class="copy-btn" onclick="copyResult()">📋 분석 결과 복사하기</button>
  </div>

  <div id="status"></div>
  <div id="result" class="result"></div>
</div>

<script>
function showPreview(target) {
  const fileInput = document.getElementById('img' + target);
  const previewBox = document.getElementById('preview' + target);
  if (fileInput.files && fileInput.files[0]) {
    const reader = new FileReader();
    reader.onload = e => {
      previewBox.innerHTML = `<img src="${e.target.result}" alt="${target} 미리보기">`;
    };
    reader.readAsDataURL(fileInput.files[0]);
  }
}

async function analyze() {
  const imgAFile = document.getElementById('imgA').files[0];
  const imgBFile = document.getElementById('imgB').files[0];
  if (!imgAFile || !imgBFile) {
    alert('두 장의 사진을 모두 업로드해주세요.');
    return;
  }
  document.getElementById('status').innerText = '분석 중...';

  const imgAData = await toBase64(imgAFile);
  const imgBData = await toBase64(imgBFile);

  const res = await fetch('/api/match', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ imgA: imgAData, imgB: imgBData })
  });
  const data = await res.json();
  document.getElementById('status').innerText = '';
  document.getElementById('result').innerText = formatResult(data);
}

function toBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result);
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

function formatResult(d) {
  const lines = [];
  lines.push(`✨ 궁합 점수: ${d.score ?? '?'} / 100`);
  if (d.score_reason) lines.push(`(점수 근거) ${d.score_reason}`);

  if (d.person1) {
    lines.push('\n👤 A의 관상 특징');
    lines.push(`- 총평: ${d.person1.overall}`);
    lines.push(`- 얼굴형: ${d.person1.face_shape}`);
    lines.push(`- 이마: ${d.person1.forehead}`);
    lines.push(`- 눈썹: ${d.person1.eyebrows}`);
    lines.push(`- 눈: ${d.person1.eyes}`);
    lines.push(`- 코: ${d.person1.nose}`);
    lines.push(`- 입/입술: ${d.person1.mouth}`);
    lines.push(`- 귀: ${d.person1.ears}`);
    lines.push(`- 턱/턱선: ${d.person1.jaw_chin}`);
    lines.push(`- 피부/표정: ${d.person1.skin_expression}`);
    if (d.person1.analysis) lines.push(`- 풀이: ${d.person1.analysis}`);
  }

  if (d.person2) {
    lines.push('\n👤 B의 관상 특징');
    lines.push(`- 총평: ${d.person2.overall}`);
    lines.push(`- 얼굴형: ${d.person2.face_shape}`);
    lines.push(`- 이마: ${d.person2.forehead}`);
    lines.push(`- 눈썹: ${d.person2.eyebrows}`);
    lines.push(`- 눈: ${d.person2.eyes}`);
    lines.push(`- 코: ${d.person2.nose}`);
    lines.push(`- 입/입술: ${d.person2.mouth}`);
    lines.push(`- 귀: ${d.person2.ears}`);
    lines.push(`- 턱/턱선: ${d.person2.jaw_chin}`);
    lines.push(`- 피부/표정: ${d.person2.skin_expression}`);
    if (d.person2.analysis) lines.push(`- 풀이: ${d.person2.analysis}`);
  }

  if (d.compatibility) {
    lines.push('\n—— 궁합 해석 ————————————————————');
    if (d.compatibility.summary) lines.push(d.compatibility.summary);
    if (d.compatibility.strengths) {
      lines.push('\n🤝 잘 맞는 점:');
      lines.push(`- ${Array.isArray(d.compatibility.strengths) ? d.compatibility.strengths.join('\n- ') : d.compatibility.strengths}`);
    }
    if (d.compatibility.cautions) {
      lines.push('\n⚠️ 조심해야 할 점:');
      lines.push(`- ${Array.isArray(d.compatibility.cautions) ? d.compatibility.cautions.join('\n- ') : d.compatibility.cautions}`);
    }
    if (d.compatibility.tips) {
      lines.push('\n💡 Tip:');
      lines.push(`- ${Array.isArray(d.compatibility.tips) ? d.compatibility.tips.join('\n- ') : d.compatibility.tips}`);
    }
  }

  lines.push('\n(※ 오락/참고용 결과입니다. 사진은 저장되지 않습니다.)');
  return lines.join('\n');
}

function copyResult() {
  const resultText = document.getElementById('result').innerText;
  navigator.clipboard.writeText(resultText).then(() => {
    alert('결과가 클립보드에 복사되었습니다.');
  });
}
</script>
</body>
</html>
