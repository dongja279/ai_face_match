<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>AI ê´€ìƒê¶í•©</title>
<style>
  /* ===== Design Tokens (Dark-first) ===== */
  :root{
    --bg:#0b111c;            /* ë°°ê²½ */
    --panel:#0e1624;         /* ì¹´ë“œ ìƒë‹¨ */
    --panel2:#0b1422;        /* ì¹´ë“œ í•˜ë‹¨ */
    --ink:#eaf0fb;           /* ë³¸ë¬¸ í…ìŠ¤íŠ¸ */
    --muted:#9fb2c8;         /* ë³´ì¡° í…ìŠ¤íŠ¸ */
    --line:#1b2740;          /* í…Œë‘ë¦¬ */
    --chip:#111b2d;          /* ì¹©/ë±ƒì§€ */
    --gradient1:#7c3aed;     /* í¬ì¸íŠ¸1 */
    --gradient2:#06b6d4;     /* í¬ì¸íŠ¸2 */
    --ok:#14a07a;            /* ì„±ê³µ ë²„íŠ¼ */
    --shadow:0 6px 30px rgba(0,0,0,.28);
  }
  @media (prefers-color-scheme: light){
    :root{
      --bg:#f6f8fc;
      --panel:#ffffff;
      --panel2:#ffffff;
      --ink:#0e1525;
      --muted:#5e6a81;
      --line:#e7edf7;
      --chip:#f3f6fc;
      --gradient1:#6d28d9;
      --gradient2:#0891b2;
      --ok:#0f8b72;
      --shadow:0 10px 26px rgba(10,35,70,.08);
    }
  }

  /* ===== Base ===== */
  *,*::before,*::after{ box-sizing:border-box }
  html,body{ height:100% }
  body{
    margin:0;
    background:var(--bg);
    color:var(--ink);
    font-family:-apple-system,BlinkMacSystemFont,"Noto Sans KR",Segoe UI,Roboto,Helvetica,Arial;
    text-rendering:optimizeLegibility;
    -webkit-font-smoothing:antialiased;
  }
  .wrap{ max-width:1040px; margin:0 auto; padding:20px }
  .eyebrow{ color:var(--muted); letter-spacing:.02em }

  /* ===== Header ===== */
  header{ display:flex; gap:16px; align-items:center; margin:4px 0 18px }
  .logo{ width:46px;height:46px;border-radius:50%;
         background:conic-gradient(from 140deg,var(--gradient1),var(--gradient2)); box-shadow:var(--shadow) }
  h1{ margin:0; font-size:clamp(24px,4.6vw,40px); letter-spacing:-.6px; line-height:1.05 }
  .sub{ margin-top:8px; color:var(--muted); font-size:clamp(13px,2.8vw,16px); }

  /* ===== Panels ===== */
  .panel{
    background:linear-gradient(180deg,var(--panel),var(--panel2));
    border:1px solid var(--line);
    border-radius:18px; padding:18px;
    box-shadow:var(--shadow);
  }
  .grid{ display:grid; gap:18px }
  .row{ display:grid; grid-template-columns:1fr 1fr; gap:18px }
  @media(max-width:760px){ .row{ grid-template-columns:1fr } }

  /* ===== Upload Slots ===== */
  .slot{
    position:relative; overflow:hidden; min-height:290px;
    border:1px solid var(--line); border-radius:16px;
    background:linear-gradient(180deg,#0c1423,#0a1220);
    display:flex; align-items:end; justify-content:center; padding:16px;
  }
  .slot img{ position:absolute; inset:0; width:100%; height:100%; object-fit:cover }
  .slot .label{
    position:absolute; left:10px; top:10px; z-index:2;
    background:var(--chip); color:#cfe1ff; border:1px solid #ffffff22;
    padding:6px 10px; border-radius:999px; font-weight:800; font-size:12px;
  }
  input[type=file]{ display:none }
  .btn-up{
    position:relative; z-index:2; border:none; cursor:pointer;
    min-height:48px; padding:14px 16px; border-radius:12px; font-weight:900; color:#fff;
    background:linear-gradient(135deg,var(--gradient1),var(--gradient2));
    width:min(88%, 360px); box-shadow:0 8px 20px rgba(10,20,40,.35);
  }

  /* ===== Meter / Status ===== */
  .meter{ height:8px;background:#0e172b;border-radius:999px;overflow:hidden;border:1px solid #ffffff18 }
  .meter>div{ height:100%;width:0%; background:linear-gradient(90deg,#22d3ee,#a78bfa,#22c55e) }
  .muted{ color:var(--muted) }

  /* ===== Actions (center) ===== */
  .actions{ display:flex; flex-direction:column; align-items:center; gap:12px; margin:18px 0 8px }
  .btn{
    width:100%; max-width:560px;
    border:none; border-radius:14px; padding:16px 18px; font-weight:900; cursor:pointer;
    font-size:clamp(15px,3.6vw,18px);
  }
  .btn.primary{ color:#fff; background:linear-gradient(135deg,var(--gradient1),var(--gradient2)); box-shadow:0 10px 24px rgba(80,35,160,.35) }
  .btn.success{ color:#fff; background:var(--ok); box-shadow:0 10px 22px rgba(20,160,122,.32) }
  .btn:disabled{ opacity:.55; cursor:not-allowed }

  /* ===== Results ===== */
  h3{ margin:0 0 12px; font-size:clamp(18px,4.3vw,22px) }
  h4{ margin:0 0 8px; font-size:clamp(16px,3.8vw,19px) }
  .section{ background:linear-gradient(180deg,var(--panel),var(--panel2)); border:1px solid var(--line); border-radius:16px; padding:16px; margin-top:16px; box-shadow:var(--shadow) }
  .who{ border:1px solid var(--line); border-radius:14px; padding:12px; margin-top:12px; background:#0c1423aa }
  .pill{ display:inline-block; font-size:12px; background:var(--chip); color:#bcd3ff; padding:6px 10px; border-radius:999px; border:1px solid #ffffff22 }
  .list{ padding-left:18px; margin:8px 0 }
  .score{ display:flex; gap:12px; align-items:center }
  .score .dot{
    width:68px; height:68px; border-radius:50%;
    background:radial-gradient(circle at 30% 30%,#a7b3ff,#7c3aed);
    display:flex; align-items:center; justify-content:center; color:#fff; font-weight:900; font-size:20px
  }

  /* ===== Footer ===== */
  footer{ margin:28px 0 10px; color:var(--muted); text-align:center }
  a.mail{ color:#9ed2ff; text-decoration:none }
</style>
</head>
<body>
  <div class="wrap">
    <!-- Header -->
    <header>
      <div class="logo" aria-hidden="true"></div>
      <div>
        <h1>AI ê´€ìƒê¶í•©</h1>
        <div class="sub">ë‘ ì‚¬ëŒì˜ ì–¼êµ´ ì‚¬ì§„ì„ ì—…ë¡œë“œí•˜ë©´, ì‹¬ì¸µ ê¶í•© ë¶„ì„ì„ ì œê³µí•©ë‹ˆë‹¤. <span class="eyebrow">(ì¬ë¯¸ë¡œë§Œ ë³´ì„¸ìš”!)</span></div>
      </div>
    </header>

    <!-- Upload -->
    <section class="panel">
      <h3>ì‚¬ì§„ ì—…ë¡œë“œ</h3>
      <div class="row" style="margin-top:10px">
        <div class="slot" id="slotA">
          <span class="label">A</span>
          <img id="imgPrevA" alt="" style="display:none">
          <input id="fileA" type="file" accept="image/*">
          <button class="btn-up" id="btnA" aria-label="A ì‚¬ì§„ ì—…ë¡œë“œ">A ì‚¬ì§„ ì—…ë¡œë“œ</button>
        </div>
        <div class="slot" id="slotB">
          <span class="label">B</span>
          <img id="imgPrevB" alt="" style="display:none">
          <input id="fileB" type="file" accept="image/*">
          <button class="btn-up" id="btnB" aria-label="B ì‚¬ì§„ ì—…ë¡œë“œ">B ì‚¬ì§„ ì—…ë¡œë“œ</button>
        </div>
      </div>

      <div style="margin-top:14px">
        <div class="meter"><div id="bar"></div></div>
        <div id="status" class="muted" style="margin-top:6px">ëŒ€ê¸° ì¤‘â€¦</div>
      </div>

      <div class="actions">
        <button id="analyze" class="btn primary">ğŸ”® ê´€ìƒê¶í•© ë¶„ì„í•˜ê¸°</button>
        <button id="shareBtn" class="btn success" disabled>ğŸ“‹ ë¶„ì„ ê²°ê³¼ ë³µì‚¬í•˜ê¸°(ë§í¬)</button>
      </div>
    </section>

    <!-- Results -->
    <div id="out"></div>

    <footer>âœ‰ï¸ ë¬¸ì˜: <a class="mail" href="mailto:dongja279@gmail.com">dongja279@gmail.com</a></footer>
  </div>

<script>
/* ===== DOM ===== */
const fileA = document.getElementById('fileA');
const fileB = document.getElementById('fileB');
const btnA  = document.getElementById('btnA');
const btnB  = document.getElementById('btnB');
const prevA = document.getElementById('imgPrevA');
const prevB = document.getElementById('imgPrevB');

const bar = document.getElementById('bar');
const statusEl = document.getElementById('status');
const analyzeBtn = document.getElementById('analyze');
const shareBtn = document.getElementById('shareBtn');
const out = document.getElementById('out');

let imgA = null, imgB = null;
let lastResult = null;
let busy = false;

/* ===== Utils ===== */
function setBusy(v){ busy=v; analyzeBtn.disabled=v; }
function toDataURL(file){
  return new Promise((resolve,reject)=>{
    const r = new FileReader();
    r.onload = () => resolve(r.result);
    r.onerror= reject;
    r.readAsDataURL(file);
  });
}
btnA.onclick = ()=> fileA.click();
btnB.onclick = ()=> fileB.click();

fileA.onchange = async (e)=>{
  const f = e.target.files?.[0]; if(!f) return;
  imgA = await toDataURL(f);
  prevA.src = imgA; prevA.style.display='block';
}
fileB.onchange = async (e)=>{
  const f = e.target.files?.[0]; if(!f) return;
  imgB = await toDataURL(f);
  prevB.src = imgB; prevB.style.display='block';
}

/* ===== Analyze ===== */
async function runAnalyze(){
  if(!imgA || !imgB){ alert('A, B ì‚¬ì§„ì„ ëª¨ë‘ ì—…ë¡œë“œí•´ ì£¼ì„¸ìš”.'); return; }
  try{
    setBusy(true);
    statusEl.textContent = 'ë¶„ì„ì¤‘â€¦';
    bar.style.width = '65%';
    shareBtn.disabled = true;

    const r = await fetch('/api/match', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ imgA, imgB })
    });
    if(!r.ok){
      const t = await r.text();
      throw new Error(t);
    }
    const data = await r.json();
    lastResult = data;
    out.innerHTML = renderAll(data);

    statusEl.textContent = 'ë¶„ì„ì™„ë£Œ!';
    bar.style.width = '100%';
    shareBtn.disabled = false;
    window.scrollTo({ top: out.offsetTop - 10, behavior:'smooth' });
  }catch(e){
    console.error(e);
    statusEl.textContent = 'ì˜¤ë¥˜';
    bar.style.width = '0%';
    alert('ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
  }finally{
    setBusy(false);
  }
}
analyzeBtn.onclick = runAnalyze;

/* ===== Share (Short Link) ===== */
shareBtn.onclick = async ()=>{
  try{
    if(!lastResult){ alert('ë¨¼ì € ë¶„ì„ì„ ì™„ë£Œí•´ ì£¼ì„¸ìš”.'); return; }
    const r = await fetch('/api/share', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ result: lastResult })
    });
    if(!r.ok) throw new Error(await r.text());
    const { id } = await r.json();
    const url = `${location.origin}/v?id=${id}`;
    await navigator.clipboard.writeText(url);
    shareBtn.textContent = 'âœ… ë§í¬ ë³µì‚¬ë¨';
    setTimeout(()=> shareBtn.textContent='ğŸ“‹ ë¶„ì„ ê²°ê³¼ ë³µì‚¬í•˜ê¸°(ë§í¬)', 1200);
    if(navigator.share){ try{ await navigator.share({ title:'AI ê´€ìƒê¶í•© ê²°ê³¼', url }); }catch{} }
  }catch(e){
    alert('ë§í¬ ìƒì„± ì‹¤íŒ¨: ' + (e?.message || e));
  }
};

/* ===== Renderers ===== */
const S = v => (v==null?'':String(v));
const L = a => (Array.isArray(a)?a:[a]).filter(Boolean).map(x=>`<li>${S(x)}</li>`).join('');

/* ìš´ì„¸ ë¸”ëŸ­: ê·¼ê±°/ê²°ë¡ /íŒ ëª¨ë‘ í‘œì‹œ */
function fortuneBlock(title, obj){
  if(!obj) return '';
  return `
    <div class="section" style="margin-top:10px">
      <span class="pill">${title}</span>
      ${obj.reason ? `<div style="margin-top:10px"><b>ê·¼ê±°:</b> ${S(obj.reason)}</div>`:''}
      ${obj.verdict? `<div style="margin-top:6px"><b>ê²°ë¡ :</b> ${S(obj.verdict)}</div>`:''}
      ${(obj.tips && obj.tips.length) ? `<ul class="list" style="margin-top:8px">${L(obj.tips)}</ul>`:''}
    </div>
  `;
}
function personBlock(label, p){
  const F = p?.fortune || {};
  return `
    <div class="who">
      <h4>${label}</h4>
      ${fortuneBlock('ì¬ë¬¼ìš´', F.wealth)}
      ${fortuneBlock('ì—°ì• ìš´', F.love)}
      ${fortuneBlock('ê±´ê°•ìš´', F.health)}
    </div>
  `;
}
function compatBlock(title, data){
  return `
    <div class="section">
      <div class="score">
        <div class="dot">${S(data?.score ?? 0)}</div>
        <h3 style="margin:0">${title}</h3>
      </div>
      <div style="margin-top:12px"><b>ì˜ ë§ëŠ” ì </b></div>
      <ul class="list">${L(data?.strengths || [])}</ul>
      <div style="margin-top:8px"><b>ì¡°ì‹¬í•´ì•¼ í•  ì </b></div>
      <ul class="list">${L(data?.cautions || [])}</ul>
    </div>
  `;
}
function renderAll(d){
  return `
    <div class="section"><h3>ğŸ‘¤ ê°œì¸ë³„ ê´€ìƒ íŠ¹ì§• & ìš´ì„¸</h3>
      ${personBlock('A', d.personA || {})}
      ${personBlock('B', d.personB || {})}
    </div>
    ${compatBlock('ğŸ’– ì—°ì• /ìš°ì •', d?.compatibility?.love_friendship || {})}
    ${compatBlock('ğŸ’¼ ë¹„ì¦ˆë‹ˆìŠ¤', d?.compatibility?.business || {})}
  `;
}

/* ===== Open Shared Link ===== */
(function bootFromShared(){
  const id = new URLSearchParams(location.search).get('id');
  if(!id) return;
  fetch(`/api/get?id=${encodeURIComponent(id)}`)
    .then(r => r.ok ? r.json() : Promise.reject('not found'))
    .then(d => {
      lastResult = d;
      out.innerHTML = renderAll(d);
      document.querySelector('.panel').style.display='none';
      statusEl.textContent = 'ë¶„ì„ì™„ë£Œ!';
      bar.style.width = '100%';
      window.scrollTo({ top: out.offsetTop - 10, behavior:'smooth' });
    })
    .catch(()=>{});
})();
</script>
</body>
</html>