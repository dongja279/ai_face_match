<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>AI ê´€ìƒê¶í•©</title>
<style>
  :root{
    --bg:#0b1220; --panel:#0f1629; --ink:#e7efff; --muted:#a6b3cc;
    --line:#1b2744; --chip:#121b31; --accent:#7c3aed; --accent2:#22d3ee;
    --ok:#16a34a; --mid:#f59e0b; --bad:#ef4444;
  }
  @media (prefers-color-scheme: light){
    :root{ --bg:#f6f8fc; --panel:#ffffff; --ink:#1b2336; --muted:#64718a; --line:#e7eef7; --chip:#f3f6fc }
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);
    font-family:-apple-system,BlinkMacSystemFont,"Apple SD Gothic Neo","Noto Sans KR",Segoe UI,Roboto,Helvetica,Arial}
  header{padding:18px 16px;border-bottom:1px solid #ffffff12;position:sticky;top:0;z-index:5;background:linear-gradient(90deg,#0e1530cc,#0b1220cc);backdrop-filter:blur(6px)}
  .wrap{max-width:960px;margin:0 auto;padding:0 16px}
  .brand{display:flex;gap:12px;align-items:center}
  .logo{width:40px;height:40px;border-radius:12px;background:conic-gradient(from 140deg,var(--accent),var(--accent2))}
  h1{font-size:22px;margin:0}
  .sub{color:#c9d6f0;font-size:13px}

  main{max-width:960px;margin:20px auto;padding:0 16px;display:grid;gap:16px}

  .panel{background:var(--panel);border:1px solid var(--line);border-radius:18px;padding:16px}
  .panel h2{margin:0 0 12px}
  .muted{color:var(--muted)}
  .btn{cursor:pointer;border:none;border-radius:14px;padding:14px 18px;font-weight:800}
  .btn.primary{background:linear-gradient(135deg,var(--accent),var(--accent2));color:#fff}
  .btn.ghost{background:var(--chip);color:var(--ink);border:1px solid var(--line)}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .center{display:flex;justify-content:center;gap:12px;flex-wrap:wrap}

  /* ì—…ë¡œë“œ ì¹´ë“œ */
  .uploadGrid{display:grid;grid-template-columns:1fr;gap:16px}
  @media (min-width:720px){ .uploadGrid{grid-template-columns:1fr 1fr} }
  .slot{background:#0d152b;border:1px dashed #28406e;border-radius:16px;padding:10px;position:relative;min-height:260px}
  .slot img{width:100%;height:240px;object-fit:cover;border-radius:10px;display:block}
  .slot .pick{position:absolute;left:50%;bottom:12px;transform:translateX(-50%);min-width:76%;}

  /* í”„ë¡œê·¸ë ˆìŠ¤ */
  .meter{height:10px;border-radius:999px;background:#0c1428;border:1px solid #ffffff18;overflow:hidden}
  .meter>div{height:100%;width:0%;background:linear-gradient(90deg,#22d3ee,#a78bfa,#22c55e);transition:width .35s ease}

  /* ê²°ê³¼ â€“ í•˜ì´ë¼ì´íŠ¸(ë‘ê´„ì‹) */
  .hi{display:grid;grid-template-columns:1fr;gap:14px}
  @media(min-width:720px){.hi{grid-template-columns:1fr 1fr}}
  .card{background:#0f1830;border:1px solid #233154;border-radius:16px;padding:14px}
  .scoreBadge{width:72px;height:72px;border-radius:50%;
    background:radial-gradient(circle at 30% 30%,#9ae6ff,#8b5cf6);
    display:flex;align-items:center;justify-content:center;color:#fff;font-weight:900;font-size:24px;flex:none;box-shadow:0 0 0 6px #ffffff0f inset}
  .headline{display:flex;gap:12px;align-items:center;margin-bottom:8px}
  .headline h3{margin:0}
  .tag{font-size:13px;color:#bcd0f5}
  .ok{box-shadow:0 0 0 6px #16a34a22 inset}
  .mid{box-shadow:0 0 0 6px #f59e0b22 inset}
  .bad{box-shadow:0 0 0 6px #ef444422 inset}

  /* ê°œì¸ë³„ */
  .who{background:#0f1830;border:1px solid #233154;border-radius:16px;padding:14px}
  .who h4{margin:0 0 8px}
  .chip{display:inline-block;background:#0f1a33;border:1px solid #213455;color:#cfe3ff;padding:4px 10px;border-radius:999px;font-size:12px;margin-bottom:10px}
  .list{margin:8px 0 0 18px}
  .list li{margin:6px 0}

  .foot{color:#9fb4d8;font-size:13px;text-align:center;margin:18px 0}
  a{color:#9bd1ff}
</style>
</head>
<body>
<header>
  <div class="wrap brand">
    <div class="logo" aria-hidden="true"></div>
    <div>
      <h1>AI ê´€ìƒê¶í•©</h1>
      <div class="sub">ë‘ ì‚¬ëŒì˜ ì–¼êµ´ ì‚¬ì§„ì„ ì—…ë¡œë“œí•˜ë©´, ì‹¬ì¸µ ê¶í•© ë¶„ì„ì„ ì œê³µí•©ë‹ˆë‹¤. (ì¬ë¯¸ë¡œë§Œ ë³´ì„¸ìš”!)</div>
    </div>
  </div>
</header>

<main>
  <!-- ì—…ë¡œë“œ -->
  <section class="panel">
    <h2>ì‚¬ì§„ ì—…ë¡œë“œ</h2>
    <div class="uploadGrid">
      <div class="slot">
        <img id="imgA" alt="A ë¯¸ë¦¬ë³´ê¸°" style="display:none"/>
        <input id="fileA" type="file" accept="image/*" style="display:none"/>
        <button id="btnA" class="btn ghost pick">ğŸ…°ï¸ A ì‚¬ì§„ ì—…ë¡œë“œ</button>
      </div>
      <div class="slot">
        <img id="imgB" alt="B ë¯¸ë¦¬ë³´ê¸°" style="display:none"/>
        <input id="fileB" type="file" accept="image/*" style="display:none"/>
        <button id="btnB" class="btn ghost pick">ğŸ…±ï¸ B ì‚¬ì§„ ì—…ë¡œë“œ</button>
      </div>
    </div>

    <div style="margin:14px 0 8px" class="meter"><div id="bar"></div></div>
    <div id="status" class="muted">ëŒ€ê¸° ì¤‘â€¦</div>

    <div class="center" style="margin-top:12px">
      <button id="analyze" class="btn primary">ğŸ”® ê´€ìƒê¶í•© ë¶„ì„í•˜ê¸°</button>
      <button id="share" class="btn ghost" disabled>ğŸ“‹ ë¶„ì„ ê²°ê³¼ ë³µì‚¬(ë§í¬)</button>
    </div>
  </section>

  <!-- ê²°ê³¼ ì˜ì—­ -->
  <section id="out"></section>

  <div class="foot">ë¬¸ì˜: <a href="mailto:dongja279@gmail.com">dongja279@gmail.com</a></div>
</main>

<script>
/* ===== ì‘ì€ ìœ í‹¸ ===== */
const $ = sel => document.querySelector(sel);
const toDataURL = file => new Promise(res=>{
  const fr=new FileReader(); fr.onload=e=>res(e.target.result); fr.readAsDataURL(file);
});
function setBusy(b,msg){
  $('#status').textContent = b ? (msg||'ë¶„ì„ ì¤‘â€¦') : 'ëŒ€ê¸° ì¤‘â€¦';
  $('#analyze').disabled = b;
}
function setProgress(p){ $('#bar').style.width = p+'%'; }

/* ===== ì—…ë¡œë“œ ì²˜ë¦¬ ===== */
let dataA=null, dataB=null, lastResult=null;

$('#btnA').onclick = ()=> $('#fileA').click();
$('#btnB').onclick = ()=> $('#fileB').click();

$('#fileA').onchange = async (e)=>{
  const f=e.target.files?.[0]; if(!f) return;
  dataA = await toDataURL(f);
  const img=$('#imgA'); img.src=dataA; img.style.display='block';
  $('#btnA').textContent='ë‹¤ì‹œ ì„ íƒ';
};
$('#fileB').onchange = async (e)=>{
  const f=e.target.files?.[0]; if(!f) return;
  dataB = await toDataURL(f);
  const img=$('#imgB'); img.src=dataB; img.style.display='block';
  $('#btnB').textContent='ë‹¤ì‹œ ì„ íƒ';
};

/* ===== ì ìˆ˜ ë±ƒì§€ ì»¬ëŸ¬/ë¬¸êµ¬ ===== */
const level = (s)=> s>=80 ? 'ok' : s>=60 ? 'mid' : 'bad';
const oneLiner = (s,kind)=> {
  if(kind==='love') return s>=80?'ìš´ëª…ì  ì°°ë–¡ê¶í•©!': s>=60?'ê°ì •ì„ ì´ ì˜ ë§ì•„ìš”':'ëŒ€í™”ì™€ ë°°ë ¤ê°€ í•„ìš”í•´ìš”';
  return s>=80?'í•¨ê»˜í•˜ë©´ 1+1=3!': s>=60?'ì—­í•  ë¶„ë‹´í•˜ë©´ ì¢‹ì•„ìš”':'ëª…í™•í•œ ë£°ì´ í•„ìš”í•´ìš”';
};

/* ===== ê²°ê³¼ ë Œë” (ë‘ê´„ì‹) ===== */
function render(d){
  // ì•ˆì „ ì ‘ê·¼ í—¬í¼
  const g = (o,k,def='') => (o && o[k]!=null ? o[k] : def);

  const loveScore = g(d.compatibility,'love_friendship',{}).score || 0;
  const bizScore  = g(d.compatibility,'business',{}).score || 0;
  const loveStr   = g(d.compatibility,'love_friendship',{}).strengths || [];
  const loveCau   = g(d.compatibility,'love_friendship',{}).cautions || [];
  const bizStr    = g(d.compatibility,'business',{}).strengths || [];
  const bizCau    = g(d.compatibility,'business',{}).cautions || [];

  const block = (title,score,strengths,cautions,emoji)=>`
    <div class="card">
      <div class="headline">
        <div class="scoreBadge ${level(score)}">${score}</div>
        <div>
          <h3 style="margin:0">${emoji} ${title}</h3>
          <div class="tag">${oneLiner(score, title.includes('ì—°ì• ')?'love':'biz')}</div>
        </div>
      </div>
      <div class="who" style="background:#0b142a;border-color:#203153">
        <h4 style="margin:0 0 6px">ì˜ ë§ëŠ” ì </h4>
        <ul class="list">${(strengths||[]).map(x=>`<li>${x}</li>`).join('')}</ul>
        <h4 style="margin:10px 0 6px">ì¡°ì‹¬í•´ì•¼ í•  ì </h4>
        <ul class="list">${(cautions||[]).map(x=>`<li>${x}</li>`).join('')}</ul>
      </div>
    </div>`;

  const fortune = (title,f)=>`
    <div class="who">
      <span class="chip">${title}</span>
      <div><b>ê·¼ê±°:</b> ${g(f,'reason','')}</div>
      <div style="margin-top:6px"><b>ê²°ë¡ :</b> ${g(f,'verdict','')}</div>
      ${Array.isArray(f?.tips) && f.tips.length ? `<ul class="list">${f.tips.map(t=>`<li>${t}</li>`).join('')}</ul>`:''}
    </div>`;

  const person = (name,p)=>`
    <div class="panel">
      <h3 style="margin:0 0 10px">${name}</h3>
      ${fortune('ì¬ë¬¼ìš´', p?.wealth)}
      ${fortune('ì—°ì• ìš´', p?.love)}
      ${fortune('ê±´ê°•ìš´', p?.health)}
    </div>`;

  return `
    <!-- í•˜ì´ë¼ì´íŠ¸ ë¨¼ì € -->
    <section class="panel">
      <h2>ê²°ê³¼ í•˜ì´ë¼ì´íŠ¸</h2>
      <div class="hi">
        ${block('ì—°ì• /ìš°ì •', loveScore, loveStr, loveCau, 'ğŸ’–')}
        ${block('ë¹„ì¦ˆë‹ˆìŠ¤', bizScore, bizStr, bizCau, 'ğŸ’¼')}
      </div>
    </section>

    <!-- ê°œì¸ë³„ ìƒì„¸ -->
    <section class="panel">
      <h2>ğŸ‘¤ ê°œì¸ë³„ ê´€ìƒ íŠ¹ì§• & ìš´ì„¸</h2>
      <div class="hi">
        ${person('A', d.personA)}
        ${person('B', d.personB)}
      </div>
    </section>
  `;
}

/* ===== ë¶„ì„ ì‹¤í–‰ ===== */
$('#analyze').onclick = async ()=>{
  if(!dataA || !dataB){ alert('A, B ì‚¬ì§„ì„ ëª¨ë‘ ì—…ë¡œë“œí•´ ì£¼ì„¸ìš”.'); return; }
  try{
    setBusy(true,'ì‚¬ì§„ ì¤€ë¹„ ì¤‘â€¦'); setProgress(10);
    // ì•½ê°„ì˜ ë‹¨ê³„ì  UI (ì§€ë£¨í•¨ ê°ì†Œ)
    setTimeout(()=>setProgress(25), 300);

    const res = await fetch('/api/match',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({ imgA:dataA, imgB:dataB })
    });

    setProgress(55);
    if(!res.ok){ const err = await res.text(); throw new Error(err||'ì„œë²„ ì˜¤ë¥˜'); }

    const json = await res.json();
    setProgress(85);
    $('#out').innerHTML = render(json);
    lastResult = json;

    setProgress(100); $('#status').textContent = 'ë¶„ì„ ì™„ë£Œ!';
    $('#share').disabled = false;

    // ê²°ê³¼ë¡œ ìŠ¤í¬ë¡¤
    setTimeout(()=>document.getElementById('out').scrollIntoView({behavior:'smooth'}), 100);
  }catch(e){
    alert('ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n\n'+(e?.message||e));
  }finally{
    setBusy(false);
  }
};

/* ===== ê³µìœ  ë§í¬ ìƒì„±( KV ì‚¬ìš© ê°€ì •: /api/share -> {key} ë°˜í™˜ ) ===== */
$('#share').onclick = async ()=>{
  if(!lastResult){ alert('ë¨¼ì € ë¶„ì„ì„ ì™„ë£Œí•´ ì£¼ì„¸ìš”.'); return; }
  try{
    const r = await fetch('/api/share',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({data:lastResult})});
    if(!r.ok){ throw new Error('ê³µìœ  ì €ì¥ ì‹¤íŒ¨'); }
    const {key} = await r.json();
    const url = `${location.origin}?r=${encodeURIComponent(key)}`;
    await navigator.clipboard.writeText(url);
    alert('ê³µìœ  ë§í¬ë¥¼ ë³µì‚¬í–ˆì–´ìš”! \n\n'+url);
  }catch(e){
    alert('ë§í¬ ìƒì„± ì‹¤íŒ¨: '+(e?.message||e));
  }
};

/* ===== ê³µìœ  ë§í¬ë¡œ ì§„ì…í•œ ê²½ìš°(ë¶ˆëŸ¬ì˜¤ê¸°) ===== */
(async ()=>{
  const params = new URLSearchParams(location.search);
  const ref = params.get('r');
  if(!ref) return;
  try{
    setBusy(true,'ê²°ê³¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦'); setProgress(30);
    const r = await fetch(`/api/get?key=${encodeURIComponent(ref)}`);
    if(!r.ok) throw new Error('ë§í¬ê°€ ë§Œë£Œë˜ì—ˆê±°ë‚˜ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
    const json = await r.json();
    $('#out').innerHTML = render(json);
    lastResult = json;
    setProgress(100); $('#status').textContent = 'ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ!';
    $('#share').disabled = false;
  }catch(e){
    alert(e?.message||e);
  }finally{
    setBusy(false);
  }
})();
</script>
</body>
</html>