<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>AI ê´€ìƒê¶í•©</title>
<style>
  :root{
    --bg:#0b1220; --panel:#0f1629; --ink:#ebf1ff; --muted:#9fb0c8; --line:#1c2942;
    --accent1:#6c5ce7; --accent2:#00d2ff; --good:#22c55e; --warn:#f59e0b; --bad:#ef4444;
  }
  body{margin:0;background:var(--bg);color:var(--ink);font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,Helvetica,Arial}
  .wrap{max-width:980px;margin:0 auto;padding:16px}
  header{display:flex;gap:12px;align-items:center;margin:6px 0 18px}
  header .logo{width:40px;height:40px;border-radius:12px;background:conic-gradient(from 180deg,var(--accent1),var(--accent2))}
  header h1{margin:0;font-size:22px}
  header p{margin:0;color:var(--muted);font-size:13px}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:16px;margin-bottom:16px}
  .grid{display:grid;gap:16px}
  @media(min-width:800px){.grid.up{grid-template-columns:1fr 1fr}}
  .slot{background:#0b1326;border:1px dashed #2a3a61;border-radius:14px;position:relative;overflow:hidden}
  .slot img{display:block;width:100%;height:auto}
  .slot .btn{
    position:absolute;left:50%;bottom:12px;transform:translateX(-50%);
    background:linear-gradient(135deg,var(--accent1),var(--accent2));
    color:#fff;border:none;border-radius:12px;padding:12px 16px;font-weight:800;cursor:pointer
  }
  .actions{display:flex;gap:12px;justify-content:center;margin-top:12px;flex-wrap:wrap}
  .btn{
    background:#15223c;border:1px solid #23345a;color:var(--ink);border-radius:12px;padding:14px 18px;font-weight:800;cursor:pointer
  }
  .btn.primary{background:linear-gradient(135deg,var(--accent1),var(--accent2));color:#fff;border:none}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  /* ì§„í–‰ë¥  */
  .progress{width:100%;height:14px;background:#0e1a33;border:1px solid #23345a;border-radius:999px;overflow:hidden;margin:10px 0 4px}
  .bar{height:100%;width:0%;background:linear-gradient(90deg,var(--accent2),var(--accent1));display:flex;align-items:center;justify-content:center;color:#001426;font-size:11px;font-weight:800;transition:width .25s}
  .ptext{color:var(--muted);font-size:12px;text-align:center;margin:0 0 2px}
  /* ê²°ê³¼ */
  .section{background:#0c152b;border:1px solid #23345a;border-radius:14px;padding:14px;margin-top:12px}
  .title{display:flex;align-items:center;gap:10px;margin:0 0 10px;font-size:18px}
  .pill{display:inline-block;background:#0f1f3e;border:1px solid #213761;border-radius:999px;padding:4px 10px;font-weight:700;margin-right:8px}
  .scoreWrap{display:flex;align-items:center;gap:12px}
  .badge{width:54px;height:54px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,var(--accent2),var(--accent1));font-size:20px;font-weight:900}
  ul.clean{margin:6px 0 0 20px}
  ul.clean li{margin:4px 0}
  footer{margin:18px 0;color:#9fb0c8;font-size:12px;text-align:center}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="logo" aria-hidden="true"></div>
    <div>
      <h1>AI ê´€ìƒê¶í•©</h1>
      <p>ë‘ ì‚¬ëŒì˜ ì–¼êµ´ ì‚¬ì§„ì„ ì—…ë¡œë“œí•˜ë©´, ì‹¬ì¸µ ê¶í•© ë¶„ì„ì„ ì œê³µí•©ë‹ˆë‹¤. (ì¬ë¯¸ë¡œë§Œ ë³´ì„¸ìš”!)</p>
    </div>
  </header>

  <!-- ì—…ë¡œë“œ -->
  <div class="card">
    <h3 style="margin:0 0 10px">ì‚¬ì§„ ì—…ë¡œë“œ</h3>
    <div class="grid up">
      <div class="slot" id="slotA">
        <img id="imgA" alt="A ë¯¸ë¦¬ë³´ê¸°" style="display:none">
        <input id="fileA" type="file" accept="image/*" capture="environment" hidden>
        <button class="btn" id="btnA">A ì‚¬ì§„ ì—…ë¡œë“œ</button>
      </div>
      <div class="slot" id="slotB">
        <img id="imgB" alt="B ë¯¸ë¦¬ë³´ê¸°" style="display:none">
        <input id="fileB" type="file" accept="image/*" capture="environment" hidden>
        <button class="btn" id="btnB">B ì‚¬ì§„ ì—…ë¡œë“œ</button>
      </div>
    </div>

    <!-- ì§„í–‰ë¥  ë°” -->
    <div class="progress"><div id="pbar" class="bar">0%</div></div>
    <p id="ptext" class="ptext">ëŒ€ê¸° ì¤‘â€¦</p>

    <!-- ì•¡ì…˜ ë²„íŠ¼(ê°€ìš´ë° ì •ë ¬) -->
    <div class="actions">
      <button id="analyze" class="btn primary" disabled>ğŸ”® ê´€ìƒê¶í•© ë¶„ì„í•˜ê¸°</button>
      <button id="share" class="btn" disabled>ğŸ“‹ ë¶„ì„ ê²°ê³¼ ë³µì‚¬í•˜ê¸°(ë§í¬)</button>
    </div>
  </div>

  <!-- ê²°ê³¼ -->
  <div id="result"></div>

  <footer>âœ‰ï¸ ë¬¸ì˜: <a href="mailto:dongja279@gmail.com" style="color:#a7c8ff">dongja279@gmail.com</a></footer>
</div>

<script>
  // ===== ë¯¸ë¦¬ë³´ê¸°/ì—…ë¡œë“œ =====
  const imgAEl = document.getElementById('imgA');
  const imgBEl = document.getElementById('imgB');
  const fileA = document.getElementById('fileA');
  const fileB = document.getElementById('fileB');
  const btnA = document.getElementById('btnA');
  const btnB = document.getElementById('btnB');
  const analyzeBtn = document.getElementById('analyze');
  const shareBtn = document.getElementById('share');
  const resultEl = document.getElementById('result');

  let imgAData = null;
  let imgBData = null;

  btnA.onclick = ()=> fileA.click();
  btnB.onclick = ()=> fileB.click();

  fileA.onchange = async(e)=> { imgAData = await readAsDataURL(e.target.files[0]); setPreview(imgAEl, imgAData); gate(); };
  fileB.onchange = async(e)=> { imgBData = await readAsDataURL(e.target.files[0]); setPreview(imgBEl, imgBData); gate(); };

  function setPreview(imgEl, data){
    imgEl.src = data; imgEl.style.display='block';
  }
  function readAsDataURL(f){
    return new Promise((res,rej)=>{ if(!f){res(null);return;}
      const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(f);
    });
  }
  function gate(){ analyzeBtn.disabled = !(imgAData && imgBData); }

  // ===== ì§„í–‰ë¥  UI =====
  const pbar = document.getElementById('pbar');
  const ptext = document.getElementById('ptext');
  function progress(p, msg){
    const v = Math.max(0, Math.min(100, Math.round(p)));
    pbar.style.width = v + '%';
    pbar.textContent = v + '%';
    ptext.textContent = msg || '';
  }
  function lockUI(on){
    [btnA,btnB,analyzeBtn,shareBtn,fileA,fileB].forEach(el=> el.disabled = on ? true : false);
  }

  // ===== ë¶„ì„ ë²„íŠ¼ =====
  analyzeBtn.onclick = async () => {
    if(!imgAData || !imgBData) return;
    try{
      lockUI(true);
      progress(10, 'ì´ë¯¸ì§€ ì¤€ë¹„ ì¤‘â€¦');
      await sleep(200);

      progress(20, 'ì´ë¯¸ì§€ ì—…ë¡œë“œ ì¤‘â€¦');
      await sleep(200);

      progress(35, 'AI ìš”ì²­ êµ¬ì„± ì¤‘â€¦');
      const payload = { imgA: imgAData, imgB: imgBData };
      await sleep(150);

      progress(55, 'AIê°€ ê´€ìƒì„ ì„¸ë°€ ë¶„ì„ ì¤‘â€¦ (ì ì‹œë§Œìš”)');
      const res = await fetch('/api/match', {
        method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)
      });

      progress(75, 'ê²°ê³¼ ì •ë¦¬ ì¤‘â€¦');
      if(!res.ok){
        const e = await res.text().catch(()=> 'Server error');
        throw new Error(e || ('HTTP '+res.status));
      }
      const data = await res.json();

      progress(95, 'ë Œë”ë§â€¦');
      render(data);
      progress(100, 'ë¶„ì„ì™„ë£Œ!');
      shareBtn.disabled = false;
    }catch(err){
      alert('ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      console.error(err);
    }finally{
      lockUI(false);
    }
  };

  // ===== ê³µìœ (ë§í¬ ë³µì‚¬) =====
  shareBtn.onclick = async ()=>{
    try{
      const url = window.location.href; // (KV ë§í¬ë¥¼ ì“°ëŠ” ë²„ì „ì´ë¼ë©´ ì—¬ê¸°ì„œ ìƒì„±í•œ ë§í¬ë¥¼ ì‚¬ìš©)
      await navigator.clipboard.writeText(url);
      shareBtn.textContent = 'âœ… ë§í¬ ë³µì‚¬ë¨';
      setTimeout(()=>shareBtn.textContent='ğŸ“‹ ë¶„ì„ ê²°ê³¼ ë³µì‚¬í•˜ê¸°(ë§í¬)',1200);
    }catch{
      alert('í´ë¦½ë³´ë“œ ë³µì‚¬ê°€ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. ì£¼ì†Œì°½ì˜ ë§í¬ë¥¼ ë³µì‚¬í•´ ì£¼ì„¸ìš”.');
    }
  };

  // ===== ê²°ê³¼ ë Œë”ë§ =====
  function render(d){
    // ì•ˆì „ ì ‘ê·¼ í—¬í¼
    const s = (v)=> v==null ? '' : String(v);
    const list = (arr)=> (arr||[]).map(t=>`<li>${s(t)}</li>`).join('');

    resultEl.innerHTML = `
      <div class="card">
        <h3 class="title">ğŸ‘¤ ê°œì¸ë³„ ê´€ìƒ íŠ¹ì§• & ìš´ì„¸</h3>
        <div class="section"><div class="pill">A</div>
          ${personBlock(d.personA)}
        </div>
        <div class="section"><div class="pill">B</div>
          ${personBlock(d.personB)}
        </div>
      </div>

      ${compatBlock('ğŸ’– ì—°ì• /ìš°ì •', d.compatibility?.love_friendship)}
      ${compatBlock('ğŸ’¼ ë¹„ì¦ˆë‹ˆìŠ¤', d.compatibility?.business)}
    `;
  }

  function personBlock(p){
    if(!p) return '<div class="muted">ë°ì´í„° ì—†ìŒ</div>';
    return `
      <div class="section">
        <div class="pill">ì¬ë¬¼ìš´</div>
        <div><b>ê·¼ê±°:</b> ${escapeHTML(p.wealth?.reason||'')}</div>
        <div><b>ê²°ë¡ :</b> ${escapeHTML(p.wealth?.verdict||'')}</div>
        ${tipsList(p.wealth?.tips)}
      </div>
      <div class="section">
        <div class="pill">ì—°ì• ìš´</div>
        <div><b>ê·¼ê±°:</b> ${escapeHTML(p.love?.reason||'')}</div>
        <div><b>ê²°ë¡ :</b> ${escapeHTML(p.love?.verdict||'')}</div>
        ${tipsList(p.love?.tips)}
      </div>
      <div class="section">
        <div class="pill">ê±´ê°•ìš´</div>
        <div><b>ê·¼ê±°:</b> ${escapeHTML(p.health?.reason||'')}</div>
        <div><b>ê²°ë¡ :</b> ${escapeHTML(p.health?.verdict||'')}</div>
        ${tipsList(p.health?.tips)}
      </div>
    `;
  }
  function tipsList(arr){
    if(!arr || !arr.length) return '';
    return `<ul class="clean">${arr.map(t=>`<li>${escapeHTML(t)}</li>`).join('')}</ul>`;
  }
  function compatBlock(title, data){
    if(!data) return '';
    return `
      <div class="card">
        <div class="title">
          <div class="badge">${Number(data.score||0)}</div>
          <div>${title}</div>
        </div>
        <div class="section">
          <div class="pill">ì˜ ë§ëŠ” ì </div>
          <ul class="clean">${(data.strengths||[]).map(t=>`<li>${escapeHTML(t)}</li>`).join('')}</ul>
        </div>
        <div class="section">
          <div class="pill">ì¡°ì‹¬í•´ì•¼ í•  ì </div>
          <ul class="clean">${(data.cautions||[]).map(t=>`<li>${escapeHTML(t)}</li>`).join('')}</ul>
        </div>
      </div>
    `;
  }

  function escapeHTML(str){ return s(str).replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
  function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }
</script>
</body>
</html>