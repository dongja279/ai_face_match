<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>AI 관상궁합</title>
<style>
  :root{
    --bg:#0b1020; --panel:#0f162b; --soft:#121a33; --ink:#eaf2ff;
    --muted:#9fb0cf; --line:#1f2a44; --accent:#7c5cff; --accent2:#22d3ee; --success:#22c55e;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);
    font-family:-apple-system,BlinkMacSystemFont,"Apple SD Gothic Neo","Noto Sans KR",Segoe UI,Roboto,Helvetica,Arial}
  .container{max-width:980px;margin:0 auto;padding:20px 16px}
  header{display:flex;gap:12px;align-items:center;padding:10px 0 18px}
  .logo{width:42px;height:42px;border-radius:12px;background:conic-gradient(from 140deg,var(--accent),var(--accent2))}
  h1{margin:0;font-size:24px}
  .sub{margin-top:2px;color:var(--muted);font-size:14px}

  /* 카드 */
  .card{background:linear-gradient(180deg,var(--panel),#0c1330);border:1px solid var(--line);
    border-radius:20px;padding:18px}
  .section-title{font-weight:800;margin:0 0 14px;font-size:18px}
  /* 업로드 영역 */
  .grid{display:grid;gap:16px}
  @media(min-width:800px){ .grid{grid-template-columns:1fr 1fr} }
  .box{
    background:#0c1326;border:1px dashed #2b3a66;border-radius:16px;
    overflow:hidden;position:relative;min-height:300px;display:flex;align-items:center;justify-content:center;
  }
  .box img{display:block;width:100%;height:100%;object-fit:cover}
  .overlay{
    position:absolute;bottom:14px;left:50%;transform:translateX(-50%);
    display:flex;gap:8px;flex-wrap:wrap;justify-content:center
  }
  .btn{border:none;border-radius:14px;padding:14px 18px;font-weight:800;cursor:pointer;color:#fff;
    background:#1b2444;transition:.2s;min-width:180px}
  .btn.primary{background:linear-gradient(135deg,var(--accent),var(--accent2))}
  .btn.secondary{background:#14304a}
  .btn:disabled{opacity:.6;cursor:not-allowed}

  /* 진행률 */
  .progress-wrap{margin:16px auto 0;max-width:520px}
  .bar{height:10px;border-radius:999px;background:#0e1a33;border:1px solid #1f2a44;overflow:hidden}
  .bar>div{height:100%;width:0%;background:linear-gradient(90deg,#22d3ee,#7c5cff,#22c55e)}
  .percent{margin-top:6px;text-align:center;color:var(--muted);font-size:13px}

  /* 결과 */
  .center{display:flex;gap:12px;justify-content:center;flex-wrap:wrap;margin-top:18px}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:10px 14px;border-radius:999px;background:#0f1a36;border:1px solid #233259;color:#cfe1ff;font-weight:700}
  .scoreCard{display:flex;align-items:center;gap:16px}
  .badge{width:54px;height:54px;border-radius:999px;display:grid;place-items:center;
    background:radial-gradient(70% 70% at 30% 30%,#8cb4ff,transparent),linear-gradient(135deg,#8b5cf6,#22d3ee)}
  .badge b{font-size:18px}
  .result-card{margin-top:14px;border-radius:18px;background:var(--soft);border:1px solid var(--line);padding:16px}
  .result-card h3{margin:0 0 12px}
  ul.clean{margin:8px 0 0 0;padding:0 0 0 20px}
  .muted{color:var(--muted)}
  footer{margin:28px 0 8px;text-align:center;color:#89a3c9;font-size:13px}
  a{color:#9ddcff;text-decoration:none}
</style>
</head>
<body>
  <div class="container">
    <header>
      <div class="logo" aria-hidden="true"></div>
      <div>
        <h1>AI 관상궁합</h1>
        <div class="sub">두 사람의 얼굴 사진을 업로드하면, 심층 궁합 분석을 제공합니다. (재미로만 보세요!)</div>
      </div>
    </header>

    <section class="card">
      <h2 class="section-title">사진 업로드</h2>
      <div class="grid">
        <!-- A -->
        <div class="box" id="boxA">
          <img id="imgA" alt="A 미리보기" style="display:none"/>
          <div class="overlay">
            <input id="fileA" type="file" accept="image/*" hidden>
            <button class="btn secondary" id="btnA">A 사진 업로드</button>
          </div>
        </div>
        <!-- B -->
        <div class="box" id="boxB">
          <img id="imgB" alt="B 미리보기" style="display:none"/>
          <div class="overlay">
            <input id="fileB" type="file" accept="image/*" hidden>
            <button class="btn secondary" id="btnB">B 사진 업로드</button>
          </div>
        </div>
      </div>

      <div class="progress-wrap">
        <div class="bar"><div id="bar"></div></div>
        <div class="percent" id="percent">대기 중…</div>
      </div>

      <div class="center">
        <button class="btn primary" id="analyze">🔮 관상궁합 분석하기</button>
        <button class="btn" id="share" disabled>📋 공유 링크 복사</button>
      </div>
    </section>

    <div id="out" style="margin-top:16px"></div>

    <footer>문의: <a href="mailto:dongja279@gmail.com">dongja279@gmail.com</a></footer>
  </div>

<script>
  // ---- DOM
  const fileA = document.getElementById('fileA');
  const fileB = document.getElementById('fileB');
  const btnA  = document.getElementById('btnA');
  const btnB  = document.getElementById('btnB');
  const imgA  = document.getElementById('imgA');
  const imgB  = document.getElementById('imgB');
  const bar   = document.getElementById('bar');
  const percent = document.getElementById('percent');
  const analyze = document.getElementById('analyze');
  const shareBtn = document.getElementById('share');
  const out = document.getElementById('out');

  let dataA=null, dataB=null, lastResult=null, lastId=null;
  const toDataURL = f => new Promise(r=>{ const fr=new FileReader(); fr.onload=e=>r(e.target.result); fr.readAsDataURL(f); });

  btnA.onclick=()=>fileA.click();
  btnB.onclick=()=>fileB.click();

  fileA.onchange=async(e)=>{
    const f=e.target.files?.[0]; if(!f) return;
    dataA=await toDataURL(f); imgA.src=dataA; imgA.style.display='block';
  };
  fileB.onchange=async(e)=>{
    const f=e.target.files?.[0]; if(!f) return;
    dataB=await toDataURL(f); imgB.src=dataB; imgB.style.display='block';
  };

  const setProgress=(p, txt)=>{ bar.style.width=p+'%'; percent.textContent = txt ?? (p<100?`${p}% 진행 중…`:'분석완료!'); };

  const sleep = ms => new Promise(r=>setTimeout(r,ms));

  async function callMatch(){ // 서버 호출
    const res = await fetch('/api/match',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({imgA:dataA,imgB:dataB})});
    if(!res.ok) throw new Error('API error');
    return res.json();
  }

  function render(d){
    // d 구조: personA{wealth{reason,verdict,tips[]}, love{...}, health{...}}, personB{...}, compatibility{love_friendship{score,strengths[],cautions[]}, business{...}}
    const sec = (title,score, strengths, cautions, icon) => `
      <section class="card" style="margin-top:14px">
        <div class="scoreCard">
          <div class="badge"><b>${score}</b></div>
          <h2 class="section-title" style="margin:0">${icon||'💖'} ${title}</h2>
        </div>
        <div class="result-card">
          <h3>잘 맞는 점</h3>
          <ul class="clean">${(strengths||[]).map(x=>`<li>${x}</li>`).join('')}</ul>
        </div>
        <div class="result-card">
          <h3>조심해야 할 점</h3>
          <ul class="clean">${(cautions||[]).map(x=>`<li>${x}</li>`).join('')}</ul>
        </div>
      </section>`;

    const fortuneBlock = (label, f) => `
      <div class="result-card">
        <div class="pill">${label}</div>
        <p><b>근거:</b> ${f.reason||''}</p>
        <p><b>결론:</b> ${f.verdict||''}</p>
        ${f.tips?.length? `<ul class="clean">${f.tips.map(t=>`<li>${t}</li>`).join('')}</ul>`:''}
      </div>`;

    const person = (title, P) => `
      <section class="card" style="margin-top:14px">
        <h2 class="section-title">👤 개인별 관상 특징 & 운세 — ${title}</h2>
        ${fortuneBlock('재물운', P?.wealth||{})}
        ${fortuneBlock('연애운', P?.love||{})}
        ${fortuneBlock('건강운', P?.health||{})}
      </section>`;

    return `
      ${person('A', d.personA||{})}
      ${person('B', d.personB||{})}
      ${sec('연애/우정', d.compatibility?.love_friendship?.score??0, d.compatibility?.love_friendship?.strengths, d.compatibility?.love_friendship?.cautions, '💖')}
      ${sec('비즈니스', d.compatibility?.business?.score??0, d.compatibility?.business?.strengths, d.compatibility?.business?.cautions, '💼')}
    `;
  }

  analyze.onclick = async ()=>{
    if(!dataA || !dataB){ alert('A, B 사진을 모두 업로드해 주세요.'); return; }
    analyze.disabled = true; shareBtn.disabled = true; out.innerHTML='';
    setProgress(10,'10% 준비 중…'); await sleep(250);
    try{
      setProgress(25,'25% 이미지 전처리…'); await sleep(200);
      setProgress(50,'50% 분석 중…');
      const d = await callMatch();
      setProgress(80,'80% 결과 정리…'); await sleep(150);
      lastResult = d; out.innerHTML = render(d);
      setProgress(100,'분석완료!');
      shareBtn.disabled = false;
    }catch(e){
      console.error(e); alert('분석 중 오류가 발생했습니다.');
      setProgress(0,'대기 중…');
    }finally{
      analyze.disabled=false;
    }
  };

  async function saveToKV(data){
    // 우선 /api/save 사용, 없으면 /api/share 사용
    try{
      const res = await fetch('/api/save',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({data})});
      if(res.ok) return (await res.json()).id;
    }catch{}
    const res2 = await fetch('/api/share',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({data})});
    if(!res2.ok) throw new Error('share failed');
    return (await res2.json()).id;
  }

  shareBtn.onclick = async ()=>{
    if(!lastResult){ alert('먼저 분석을 완료해 주세요.'); return; }
    try{
      shareBtn.disabled = true; shareBtn.textContent='저장 중…';
      const id = await saveToKV(lastResult);
      lastId = id;
      const url = `${location.origin}/?r=${encodeURIComponent(id)}`;
      await navigator.clipboard.writeText(url);
      shareBtn.textContent='복사 완료!';
      setTimeout(()=>{shareBtn.textContent='📋 공유 링크 복사'; shareBtn.disabled=false;}, 1200);
    }catch(e){
      console.error(e); alert('공유 링크 생성 실패');
      shareBtn.textContent='📋 공유 링크 복사'; shareBtn.disabled=false;
    }
  };

  // 공유 링크로 진입한 경우 로드
  (async function autoLoad(){
    const id = new URL(location.href).searchParams.get('r');
    if(!id) return;
    percent.textContent='공유 결과 불러오는 중…';
    try{
      // /api/load 우선, 없으면 /api/get
      let res = await fetch(`/api/load?id=${encodeURIComponent(id)}`);
      if(!res.ok) res = await fetch(`/api/get?id=${encodeURIComponent(id)}`);
      if(!res.ok) throw 0;
      const d = await res.json();
      lastResult=d; out.innerHTML=render(d); setProgress(100,'분석완료!');
      shareBtn.disabled=false;
    }catch{ percent.textContent='결과를 불러올 수 없습니다.'; }
  })();
</script>
</body>
</html>